<div class="shuhai-create-item-dialog">
  {{!-- 头部：角色头像 --}}
  <div class="dialog-header">
    <img class="profile-img" src="{{actor.img}}" title="{{actor.name}}"/>
    <div class="header-text">
      <h3>创建新物品</h3>
      <p>角色：{{actor.name}}</p>
    </div>
  </div>

  <div class="dialog-body">
    <div class="form-row">
      <div class="form-group full-width">
        <label>物品名称:</label>
        <input type="text" name="name" placeholder="输入物品名称" autofocus/>
      </div>
    </div>

  <div class="form-row">
    <div class="form-group half-width">
      <label>物品类型:</label>
      <select name="type" class="item-type-select">
        <option value="combatDice">攻击骰</option>
        <option value="shootDice">射击骰</option>
        <option value="defenseDice">守备骰</option>
        <option value="triggerDice">触发骰</option>
        <option value="passiveDice">被动骰</option>
        <option value="weapon">武器</option>
        <option value="armor">防具</option>
        <option value="item">物品</option>
        <option value="equipment">装备</option>
      </select>
    </div>

    <div class="form-group half-width">
      <label>分类:</label>
      {{!-- 骰子类型使用下拉选择 --}}
      <select name="category" class="category-select" style="display: none;">
        <option value="打击">打击</option>
      </select>
      {{!-- 自定义类型使用输入框 --}}
      <input type="text" name="category" class="category-input" style="display: none;" placeholder="输入自定义分类"/>
    </div>
  </div>

  <div class="form-row">
    <div class="form-group half-width">
      <label>骰数:</label>
      <input type="text" name="diceFormula" placeholder="1d6+3 或 ★ ▼ O"/>
    </div>

    <div class="form-group half-width">
      <label>费用:</label>
      <input type="text" name="cost" placeholder="数字 / Cost:x / San:x / -" value="-"/>
    </div>
  </div>

  <div class="form-row">
    <div class="form-group half-width">
      <label>数量:</label>
      <input type="number" name="quantity" value="1" min="0"/>
    </div>

    <div class="form-group half-width">
      <label>星光消耗:</label>
      <input type="number" name="starlightCost" value="0" min="0"/>
    </div>
  </div>

  <div class="form-group full-width">
    <label>标签:</label>
    <input type="text" name="tags" placeholder="标签（用逗号分隔）"/>
  </div>

  <div class="form-group full-width">
    <label>效果描述:</label>
    <textarea name="effect" rows="4" placeholder="描述物品的效果..."></textarea>
  </div>

  <div class="form-group full-width armor-properties" style="display: none;">
    <label>防具属性:</label>
    <div class="armor-props-grid">
      <label><input type="checkbox" name="slashUp"/> 斩击↑</label>
      <label><input type="checkbox" name="pierceUp"/> 突刺↑</label>
      <label><input type="checkbox" name="bluntUp"/> 打击↑</label>
      <label><input type="checkbox" name="slashDown"/> 斩击↓</label>
      <label><input type="checkbox" name="pierceDown"/> 突刺↓</label>
      <label><input type="checkbox" name="bluntDown"/> 打击↓</label>
    </div>
  </div>

  <div class="info-box">
    <p><i class="fas fa-info-circle"></i> 填写完成后点击创建，您还可以在物品表单中继续编辑。</p>
  </div>
  </div>{{!-- 关闭 dialog-body --}}
</div>

<style>
.shuhai-create-item-dialog {
  max-height: 70vh;
  overflow-y: auto;
  background: #2a2a2a;
  color: #e0e0e0;
}

.shuhai-create-item-dialog .dialog-header {
  display: flex;
  gap: 1rem;
  padding: 1rem;
  background: #1e1e1e;
  border-bottom: 2px solid #3a3a3a;
  align-items: center;
}

.shuhai-create-item-dialog .dialog-header .profile-img {
  width: 60px;
  height: 60px;
  border: 2px solid #4a4a4a;
  border-radius: 8px;
  object-fit: cover;
}

.shuhai-create-item-dialog .dialog-header .header-text h3 {
  margin: 0 0 0.25rem 0;
  color: #e0e0e0;
  font-size: 1.2rem;
}

.shuhai-create-item-dialog .dialog-header .header-text p {
  margin: 0;
  color: #999;
  font-size: 0.875rem;
}

.shuhai-create-item-dialog .dialog-body {
  padding: 1rem;
}

.shuhai-create-item-dialog .form-row {
  display: flex;
  gap: 1rem;
  margin-bottom: 1rem;
}

.shuhai-create-item-dialog .form-group {
  display: flex;
  flex-direction: column;
}

.shuhai-create-item-dialog .form-group.full-width {
  flex: 1 1 100%;
}

.shuhai-create-item-dialog .form-group.half-width {
  flex: 1 1 calc(50% - 0.5rem);
}

.shuhai-create-item-dialog label {
  font-weight: bold;
  margin-bottom: 0.25rem;
  font-size: 0.875rem;
  color: #bbb;
}

.shuhai-create-item-dialog input,
.shuhai-create-item-dialog select,
.shuhai-create-item-dialog textarea {
  width: 100%;
  padding: 0.5rem;
  background: #333;
  border: 1px solid #4a4a4a;
  border-radius: 4px;
  color: #e0e0e0;
  font-family: inherit;
}

.shuhai-create-item-dialog input:focus,
.shuhai-create-item-dialog select:focus,
.shuhai-create-item-dialog textarea:focus {
  outline: none;
  border-color: #3498db;
}

.shuhai-create-item-dialog textarea {
  resize: vertical;
}

.shuhai-create-item-dialog .armor-props-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 0.5rem;
  margin-top: 0.5rem;
}

.shuhai-create-item-dialog .armor-props-grid label {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem;
  background: #333;
  border-radius: 4px;
  cursor: pointer;
  font-weight: normal;
}

.shuhai-create-item-dialog .armor-props-grid label:hover {
  background: #3a3a3a;
}

.shuhai-create-item-dialog .armor-props-grid input[type="checkbox"] {
  width: auto;
  margin: 0;
}

.shuhai-create-item-dialog .info-box {
  background: rgba(52, 152, 219, 0.1);
  border-left: 3px solid #3498db;
  padding: 0.75rem;
  border-radius: 3px;
  margin-top: 1rem;
}

.shuhai-create-item-dialog .info-box p {
  margin: 0;
  font-size: 0.875rem;
  color: #64b5f6;
}
</style>

<script>
(function() {
  // 使用最近的dialog容器作为上下文，避免多开对话框时冲突
  const dialog = document.currentScript.closest('.shuhai-create-item-dialog');
  if (!dialog) return;

  const typeSelect = dialog.querySelector('.item-type-select');
  const categorySelect = dialog.querySelector('.category-select');
  const categoryInput = dialog.querySelector('.category-input');
  const armorProps = dialog.querySelector('.armor-properties');
  const diceFormulaInput = dialog.querySelector('[name="diceFormula"]');

  // 固定分类的骰子类型
  const diceCategories = {
    'combatDice': ['打击', '突刺', '斩击'],
    'shootDice': ['打击', '突刺', '斩击'],
    'defenseDice': ['闪避', '反击-斩击', '反击-突刺', '反击-打击', '强化反击-斩击', '强化反击-突刺', '强化反击-打击', '防御', '强化防御'],
    'triggerDice': ['EX'],
    'passiveDice': ['标签']
  };

  // 默认骰数
  const defaultDiceFormulas = {
    'combatDice': '1d6+3',
    'shootDice': '1d6+3',
    'defenseDice': '1d10',
    'triggerDice': '★',
    'passiveDice': 'O',
    'weapon': '▼',
    'armor': '▼',
    'item': '▼',
    'equipment': '▼'
  };

  // 需要自定义填写的类型
  const customTypes = ['weapon', 'armor', 'item', 'equipment'];

  function updateCategories() {
    const type = typeSelect.value;

    // 自动填充骰数
    if (defaultDiceFormulas[type]) {
      diceFormulaInput.value = defaultDiceFormulas[type];
    }

    // 判断是骰子类型还是自定义类型
    if (diceCategories[type]) {
      // 骰子类型：显示select，隐藏并禁用input
      categorySelect.style.display = 'block';
      categorySelect.disabled = false;
      categoryInput.style.display = 'none';
      categoryInput.disabled = true;

      // 填充骰子分类选项
      const categories = diceCategories[type];
      categorySelect.innerHTML = '';
      categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        categorySelect.appendChild(option);
      });
    } else {
      // 自定义类型：显示input，隐藏并禁用select
      categorySelect.style.display = 'none';
      categorySelect.disabled = true;
      categoryInput.style.display = 'block';
      categoryInput.disabled = false;
      categoryInput.value = '';
    }

    // 显示/隐藏防具属性
    if (type === 'armor') {
      armorProps.style.display = 'block';
    } else {
      armorProps.style.display = 'none';
    }
  }

  typeSelect.addEventListener('change', updateCategories);
  updateCategories();
})();
</script>