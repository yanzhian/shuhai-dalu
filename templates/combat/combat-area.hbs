<div class="combat-area-wrapper">

  {{!-- 左侧区域 (270px宽) --}}
  <div class="combat-left-panel">

    {{!-- 1. 头像容器 (270x270px) --}}
    <div class="avatar-container">
      <img src="{{actor.img}}" alt="{{actor.name}}" class="avatar-image" />
      <button class="lock-btn {{#if isLocked}}locked{{/if}}" type="button" title="锁定/解锁">
        <i class="fas {{#if isLocked}}fa-lock{{else}}fa-lock-open{{/if}}"></i>
      </button>
    </div>

    {{!-- 2. 生命值/侵蚀度/混乱值区域 (96px高) --}}
    <div class="status-bars-container">
      {{!-- 生命值 --}}
      <div class="status-bar hp-bar">
        <div class="bar-progress">
          <div class="bar-fill" style="width: {{multiply (divide system.derived.hp.value system.derived.hp.max) 100}}%"></div>
          {{#if isLocked}}
            <span class="bar-text">{{system.derived.hp.value}}/{{system.derived.hp.max}}</span>
          {{else}}
            <span class="bar-text">
              <input type="number" class="bar-value-input" data-bar-type="hp" value="{{system.derived.hp.value}}" min="0" />
              /{{system.derived.hp.max}}
            </span>
          {{/if}}
        </div>
      </div>

      {{!-- 侵蚀度和混乱值并排 --}}
      <div class="status-bars-row">
        {{!-- 侵蚀度 --}}
        <div class="status-bar erosion-bar">
          <div class="bar-progress">
            <div class="bar-fill" style="width: {{multiply (divide system.derived.corruption.value system.derived.corruption.max) 100}}%"></div>
            {{#if isLocked}}
              <span class="bar-text">{{system.derived.corruption.value}}/{{system.derived.corruption.max}}</span>
            {{else}}
              <span class="bar-text">
                <input type="number" class="bar-value-input" data-bar-type="erosion" value="{{system.derived.corruption.value}}" min="0" />
                /{{system.derived.corruption.max}}
              </span>
            {{/if}}
          </div>
        </div>

        {{!-- 混乱值 --}}
        <div class="status-bar chaos-bar">
          <div class="bar-progress">
            <div class="bar-fill" style="width: {{multiply (divide system.derived.chaos.value system.derived.chaos.max) 100}}%"></div>
            {{#if isLocked}}
              <span class="bar-text">{{system.derived.chaos.value}}/{{system.derived.chaos.max}}</span>
            {{else}}
              <span class="bar-text">
                <input type="number" class="bar-value-input" data-bar-type="chaos" value="{{system.derived.chaos.value}}" min="0" />
                /{{system.derived.chaos.max}}
              </span>
            {{/if}}
          </div>
        </div>
      </div>
    </div>

    {{!-- 3. Cost/EX资源 + 抽取按钮 --}}
    <div class="resources-control-container">
      {{!-- 左侧：资源 --}}
      <div class="resources-area">
        {{!-- Cost资源 (6个) --}}
        <div class="resource-row">
          <span class="resource-label">Cost</span>
          <div class="resource-circles">
            {{#each combatState.costResources as |active index|}}
              <button class="resource-circle cost-circle {{#if active}}active{{/if}}" data-type="cost" data-index="{{@index}}" type="button"></button>
            {{/each}}
          </div>
        </div>

        {{!-- EX资源 (3个) --}}
        <div class="resource-row">
          <span class="resource-label">EX</span>
          <div class="resource-circles">
            {{#each combatState.exResources as |active index|}}
              <button class="resource-circle ex-circle {{#if active}}active{{/if}}" data-type="ex" data-index="{{@index}}" type="button"></button>
            {{/each}}
          </div>
        </div>
      </div>

      {{!-- 右侧：按钮 --}}
      <div class="control-buttons-area">
        <button class="draw-activate-btn control-btn" type="button">抽取<br/>激活</button>
        <button class="draw-one-btn control-btn" type="button">抽取<br/>一个</button>
      </div>
    </div>

    {{!-- 4. 分割线 --}}
    <div class="divider"></div>

    {{!-- 5. 战斗骰/守备/触发/装备区域（统一） --}}
    <div class="combat-dice-section">
      {{!-- <div class="combat-section-title">战斗骰</div> --}}
      <div class="combat-dice-grid">
        {{!-- 战斗骰 1-6 --}}
        {{#each combatDiceSlots as |slot index|}}
          <div class="combat-dice-slot {{#unless slot.item}}empty{{/unless}}" data-index="{{@index}}">
            {{#if slot.item}}
              {{!-- 有装备的骰子 --}}
              <div class="dice-cost-badge">{{slot.item.system.cost}}</div>
              <button class="dice-activate-toggle {{#if slot.activated}}active{{/if}}" data-index="{{@index}}" type="button">
                <i class="fas fa-circle"></i>
              </button>
              <div class="dice-count-badge">{{slot.item.system.diceFormula}}</div>
              <button class="combat-dice-initiate-btn" data-index="{{@index}}" type="button" title="{{slot.item.name}}&#10;{{slot.item.type}} {{slot.item.system.category}}&#10;{{slot.item.system.effect}}">
                <img src="{{slot.item.img}}" alt="{{slot.item.name}}" />
              </button>
            {{else}}
              {{!-- 空槽 --}}
              <div class="dice-slot-label">战斗骰{{add @index 1}}</div>
            {{/if}}
          </div>
        {{/each}}

        {{!-- 守备骰 --}}
        <div class="combat-dice-slot {{#unless equipment.defenseDice}}empty{{/unless}}">
          {{#if equipment.defenseDice}}
            <div class="dice-cost-badge">{{equipment.defenseDice.system.cost}}</div>
            <div class="dice-count-badge">{{equipment.defenseDice.system.diceFormula}}</div>
            <button class="combat-dice-initiate-btn" type="button" title="{{equipment.defenseDice.name}}&#10;{{equipment.defenseDice.type}} {{equipment.defenseDice.system.category}}&#10;{{equipment.defenseDice.system.effect}}">
              <img src="{{equipment.defenseDice.img}}" alt="{{equipment.defenseDice.name}}" />
            </button>
          {{else}}
            <div class="dice-slot-label">守备骰</div>
          {{/if}}
        </div>

        {{!-- 触发骰 --}}
        <div class="combat-dice-slot {{#unless equipment.triggerDice}}empty{{/unless}}">
          {{#if equipment.triggerDice}}
            <div class="dice-cost-badge">{{equipment.triggerDice.system.cost}}</div>
            <div class="dice-count-badge">{{equipment.triggerDice.system.diceFormula}}</div>
            <button class="combat-dice-initiate-btn" type="button" title="{{equipment.triggerDice.name}}&#10;{{equipment.triggerDice.type}} {{equipment.triggerDice.system.category}}&#10;{{equipment.triggerDice.system.effect}}">
              <img src="{{equipment.triggerDice.img}}" alt="{{equipment.triggerDice.name}}" />
            </button>
          {{else}}
            <div class="dice-slot-label">触发骰</div>
          {{/if}}
        </div>

        {{!-- 装备 1-4 --}}
        {{#each equipment.slots as |slot index|}}
          <div class="combat-dice-slot {{#unless slot}}empty{{/unless}}">
            {{#if slot}}
              <button class="combat-dice-initiate-btn" type="button" title="{{slot.name}}&#10;{{slot.type}} {{slot.system.category}}&#10;{{slot.system.effect}}">
                <img src="{{slot.img}}" alt="{{slot.name}}" />
              </button>
            {{else}}
              <div class="dice-slot-label">装备{{add @index 1}}</div>
            {{/if}}
          </div>
        {{/each}}
      </div>
    </div>

  </div>

  {{!-- 右侧区域 --}}
  <div class="combat-right-panel">

    {{!-- 1. 信息显示区域 --}}
    <div class="info-display-area">

      {{!-- 玩家名字 (40px高) --}}
      <div class="player-name-display">{{actor.name}}</div>

      {{!-- 防具信息 --}}
      <div class="armor-info-display">
        {{#if equipment.armor}}
          <span class="armor-label" title="{{equipment.armor.name}}&#10;{{equipment.armor.system.category}}&#10;{{equipment.armor.system.effect}}">防具</span>
          <span class="armor-category">{{equipment.armor.system.category}}</span>
          {{#if equipment.armor.system.armorProperties}}
            <div class="armor-resistances">
              {{#if equipment.armor.system.armorProperties.slashUp}}
                <span class="resistance-badge up">斩↑</span>
              {{/if}}
              {{#if equipment.armor.system.armorProperties.pierceUp}}
                <span class="resistance-badge up">突刺↑</span>
              {{/if}}
              {{#if equipment.armor.system.armorProperties.bluntUp}}
                <span class="resistance-badge up">打击↑</span>
              {{/if}}
              {{#if equipment.armor.system.armorProperties.slashDown}}
                <span class="resistance-badge down">斩↓</span>
              {{/if}}
              {{#if equipment.armor.system.armorProperties.pierceDown}}
                <span class="resistance-badge down">突刺↓</span>
              {{/if}}
              {{#if equipment.armor.system.armorProperties.bluntDown}}
                <span class="resistance-badge down">打击↓</span>
              {{/if}}
            </div>
          {{/if}}
        {{else}}
          <span class="no-armor">无防具</span>
        {{/if}}
      </div>

      {{!-- 武器信息 --}}
      <div class="weapon-info-display">
        {{#if equipment.weapon}}
          <span class="weapon-label" title="{{equipment.weapon.name}}&#10;{{equipment.weapon.system.category}}&#10;{{equipment.weapon.system.effect}}">武器</span>
          <span class="weapon-category">{{equipment.weapon.system.category}}</span>
        {{else}}
          <span class="no-weapon">无武器</span>
        {{/if}}
      </div>

      {{!-- 总速度 + 先攻按钮 --}}
      <div class="speed-initiative-area">
        <div class="speed-displays">
          <div class="speed-item total-speed">总速度: <span>{{add (add speedValues.[0] speedValues.[1]) speedValues.[2]}}</span></div>
          <div class="speed-item">速度1: <span>{{speedValues.[0]}}</span></div>
          <div class="speed-item">速度2: <span>{{speedValues.[1]}}</span></div>
          <div class="speed-item">速度3: <span>{{speedValues.[2]}}</span></div>
        </div>
        <button class="initiative-btn" type="button">先攻</button>
      </div>

      {{!-- 被动骰显示（右侧的被动骰） --}}
      <div class="passive-dice-display">
        {{#each passiveDiceSlots as |slot index|}}
          {{#if slot}}
            <button class="passive-dice-icon" type="button" title="{{slot.name}}&#10;{{slot.type}} {{slot.system.category}}&#10;{{slot.system.effect}}">
              <img src="{{slot.img}}" alt="{{slot.name}}" />
            </button>
          {{/if}}
        {{/each}}
      </div>

      {{!-- 两个按钮 --}}
      <div class="action-buttons-area">
        <button class="action-dice-theme-btn" type="button">
          <i class="fas fa-dice-d20"></i> 行动骰装扮
        </button>
        <button class="summon-action-dice-btn control-btn" type="button">
          召唤行动骰
        </button>
      </div>
    </div>

    {{!-- 2. BUFF显示区域 --}}
    <div class="buff-display-area">
      <div class="buff-icons-grid">
        {{#each combatState.buffs as |buff index|}}
          <button class="buff-icon" type="button" title="{{buff.name}}&#10;{{buff.layers}}/{{buff.strength}}&#10;{{buff.description}}" data-buff-index="{{@index}}">
            <img src="{{buff.icon}}" alt="{{buff.name}}" />
          </button>
        {{/each}}
      </div>
    </div>

    {{!-- 3. 分割线 --}}
    <div class="divider"></div>

    {{!-- 4. BUFF列表区域 --}}
    <div class="buff-list-area">
      {{!-- 表头 --}}
      <div class="buff-list-header">
        <span class="buff-col-icon">图标</span>
        <span class="buff-col-name">名称</span>
        <span class="buff-col-layers">层数</span>
        <span class="buff-col-strength">强度</span>
        <span class="buff-col-actions">操作</span>
      </div>

      {{!-- BUFF条目 --}}
      <div class="buff-list-items">
        {{#each combatState.buffs as |buff index|}}
          <div class="buff-list-item">
            <div class="buff-col-icon">
              <img src="{{buff.icon}}" alt="{{buff.name}}" />
            </div>
            <div class="buff-col-name">{{buff.name}}</div>
            <div class="buff-col-layers">
              <input type="number" class="buff-value-input" value="{{buff.layers}}" data-buff-index="{{@index}}" data-field="layers" min="0" />
            </div>
            <div class="buff-col-strength">
              <input type="number" class="buff-value-input" value="{{buff.strength}}" data-buff-index="{{@index}}" data-field="strength" min="0" />
            </div>
            <div class="buff-col-actions">
              <button class="buff-trigger-btn" data-buff-index="{{@index}}" type="button">触发</button>
              <button class="buff-delete-btn" data-buff-index="{{@index}}" type="button">删除</button>
            </div>
          </div>
        {{/each}}
      </div>

      {{!-- 添加新BUFF按钮 --}}
      <button class="add-buff-btn" type="button">
        <i class="fas fa-plus"></i> 添加新的BUFF
      </button>
    </div>

  </div>

</div>
