<div class="battle-hud-window {{#if hudState.minimized}}minimized{{/if}}">
  {{!-- HUD头部 (可拖动区域) --}}
  <div class="hud-header">
    <div class="hud-title">敌方信息表</div>
    <div class="hud-controls">
      <button class="hud-control-btn hud-scale-down" title="缩小"><i class="fas fa-search-minus"></i></button>
      <button class="hud-control-btn hud-scale-up" title="放大"><i class="fas fa-search-plus"></i></button>
      <button class="hud-control-btn hud-minimize-toggle" title="{{#if hudState.minimized}}展开{{else}}最小化{{/if}}">
        <i class="fas fa-{{#if hudState.minimized}}plus{{else}}minus{{/if}}"></i>
      </button>
      <button class="hud-control-btn close" title="关闭"><i class="fas fa-times"></i></button>
    </div>
  </div>

  {{!-- HUD内容区域 --}}
  {{#unless hudState.minimized}}
  <div class="hud-content">
    {{!-- 玩家卡片列表 --}}
    <div class="hud-players-container">
      {{#each players as |player|}}
        <div class="hud-player-card" data-actor-id="{{player.actor.id}}">
          {{!-- 移除按钮 --}}
          <button class="hud-remove-player-btn" title="移出战斗"><i class="fas fa-times-circle"></i></button>

          {{!-- 战斗区域信息 --}}
          <div class="hud-battle-area-info">
            {{!-- 左侧头像 --}}
            <div class="hud-avatar">
              <img src="{{player.actor.img}}" alt="{{player.actor.name}}" />
            </div>

            {{!-- 右侧信息 --}}
            <div class="hud-info-right">
              {{!-- 玩家名字和速度 --}}
              <div class="hud-name-speed-row">
                <div class="hud-player-name">{{player.actor.name}}</div>
                <div class="hud-speed-circles">
                  {{#each player.speedValues as |speed index|}}
                    <div class="hud-speed-circle">{{speed}}</div>
                  {{/each}}
                </div>
              </div>

              {{!-- 生命值条 --}}
              <div class="hud-status-bar hud-hp-bar">
                <div class="hud-bar-fill" style="width: {{multiply (divide player.system.derived.hp.value player.system.derived.hp.max) 100}}%;"></div>
                <div class="hud-bar-text">{{player.system.derived.hp.value}}/{{player.system.derived.hp.max}}</div>
              </div>

              {{!-- 侵蚀度和混乱值 --}}
              <div class="hud-status-bars-row">
                <div class="hud-status-bar hud-erosion-bar">
                  <div class="hud-bar-fill" style="width: {{multiply (divide player.system.derived.corruption.value player.system.derived.corruption.max) 100}}%;"></div>
                  <div class="hud-bar-text">{{player.system.derived.corruption.value}}/{{player.system.derived.corruption.max}}</div>
                </div>
                <div class="hud-status-bar hud-chaos-bar">
                  <div class="hud-bar-fill" style="width: {{multiply (divide player.system.derived.chaos.value player.system.derived.chaos.max) 100}}%;"></div>
                  <div class="hud-bar-text">{{player.system.derived.chaos.value}}/{{player.system.derived.chaos.max}}</div>
                </div>
              </div>

              {{!-- Cost和EX资源 --}}
              <div class="hud-resources-row">
                <div class="hud-resource-section">
                  <span class="hud-resource-label">Cost</span>
                  <div class="hud-resource-circles">
                    {{#each player.combatState.costResources as |active index|}}
                      <div class="hud-resource-circle {{#if active}}active{{/if}}"></div>
                    {{/each}}
                  </div>
                </div>
                <div class="hud-resource-section">
                  <span class="hud-resource-label">EX</span>
                  <div class="hud-resource-circles">
                    {{#each player.combatState.exResources as |active index|}}
                      <div class="hud-resource-circle {{#if active}}active{{/if}}"></div>
                    {{/each}}
                  </div>
                </div>
              </div>

              {{!-- 战斗骰激活状态 --}}
              <div class="hud-combat-dice-row">
                {{#each player.combatDiceSlots as |slot|}}
                  <div class="hud-dice-slot {{#if slot.activated}}activated{{/if}}">
                    {{#if slot.item}}
                      <img src="{{slot.item.img}}" alt="{{slot.item.name}}" title="{{slot.item.name}}&#10;{{slot.item.system.category}}&#10;{{slot.item.system.diceFormula}}&#10;费用: {{slot.item.system.cost}}&#10;{{slot.item.system.effect}}" />
                      <div class="hud-dice-activation-indicator {{#if slot.activated}}active{{/if}}"></div>
                    {{/if}}
                  </div>
                {{/each}}
              </div>
            </div>
          </div>

          {{!-- BUFF信息区域 --}}
          <div class="hud-buff-area">
            <div class="hud-buff-slots">
              {{#each player.combatState.buffs as |buff index|}}
                <div class="hud-buff-slot" data-buff-index="{{index}}" title="{{buff.name}}&#10;{{buff.description}}">
                  <img src="{{buff.icon}}" alt="{{buff.name}}" />
                  <div class="hud-buff-layers">{{buff.layers}}</div>
                  <div class="hud-buff-strength">{{buff.strength}}</div>
                </div>
              {{/each}}

              {{!-- 空BUFF槽（点击跳转到战斗区域） --}}
              {{#unless player.combatState.buffs.length}}
                {{#times 6}}
                  <div class="hud-buff-slot empty" title="点击打开战斗区域"></div>
                {{/times}}
              {{else}}
                {{#if (lt player.combatState.buffs.length 6)}}
                  {{#times (subtract 6 player.combatState.buffs.length)}}
                    <div class="hud-buff-slot empty" title="点击打开战斗区域"></div>
                  {{/times}}
                {{/if}}
              {{/unless}}
            </div>
          </div>
        </div>
      {{/each}}

      {{!-- 如果没有参战角色，显示提示 --}}
      {{#unless players.length}}
        <div class="hud-empty-message">
          <i class="fas fa-users-slash"></i>
          <p>暂无参战角色</p>
          <p style="font-size: 12px; color: #888;">点击下方按钮加入角色</p>
        </div>
      {{/unless}}
    </div>

    {{!-- 分割线 --}}
    <div class="hud-divider"></div>

    {{!-- 加入战斗轮按钮 --}}
    <button class="hud-join-battle-btn">
      <i class="fas fa-plus-circle"></i> 点击加入战斗轮
    </button>
  </div>
  {{/unless}}
</div>
