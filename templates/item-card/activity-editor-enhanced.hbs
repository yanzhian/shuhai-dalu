<div class="activity-editor-enhanced">

  {{!-- æ ‡ç­¾é¡µå¯¼èˆª --}}
  <div class="tabs">
    <button class="tab-btn {{#if isBasicMode}}active{{/if}}" data-mode="basic">
      <i class="fas fa-edit"></i> åŸºç¡€ç¼–è¾‘å™¨
    </button>
    <button class="tab-btn {{#if isAdvancedMode}}active{{/if}}" data-mode="advanced">
      <i class="fas fa-code"></i> é«˜çº§æ¨¡å¼ (JSON)
    </button>
  </div>

  <form class="activity-editor-form">

    {{!-- ========== åŸºç¡€ç¼–è¾‘å™¨ ========== --}}
    {{#if isBasicMode}}
    <div class="tab-content tab-basic active">

      {{!-- æ´»åŠ¨åç§° --}}
      <div class="form-group">
        <label>æ´»åŠ¨åç§°</label>
        <input type="text" name="name" value="{{activity.name}}" placeholder="ä¾‹å¦‚ï¼šæ”»å‡»å‘½ä¸­æ—¶-ç‡ƒçƒ§æ•ˆæœ" />
      </div>

      {{!-- è§¦å‘æ—¶æœº --}}
      <div class="form-group">
        <label>è§¦å‘æ—¶æœº</label>
        <select name="trigger">
          <option value="onUse" {{#if (eq activity.trigger "onUse")}}selected{{/if}}>ä½¿ç”¨æ—¶</option>
          <option value="onAttack" {{#if (eq activity.trigger "onAttack")}}selected{{/if}}>æ”»å‡»æ—¶</option>
          <option value="onCounter" {{#if (eq activity.trigger "onCounter")}}selected{{/if}}>å¯¹æŠ—æ—¶</option>
          <option value="onCounterSuccess" {{#if (eq activity.trigger "onCounterSuccess")}}selected{{/if}}>å¯¹æŠ—æˆåŠŸ</option>
          <option value="onCounterFail" {{#if (eq activity.trigger "onCounterFail")}}selected{{/if}}>å¯¹æŠ—å¤±è´¥</option>
          <option value="onHit" {{#if (eq activity.trigger "onHit")}}selected{{/if}}>æ”»å‡»å‘½ä¸­</option>
          <option value="onDamaged" {{#if (eq activity.trigger "onDamaged")}}selected{{/if}}>å—åˆ°ä¼¤å®³</option>
          <option value="onTurnStart" {{#if (eq activity.trigger "onTurnStart")}}selected{{/if}}>å›åˆå¼€å§‹</option>
          <option value="onTurnEnd" {{#if (eq activity.trigger "onTurnEnd")}}selected{{/if}}>å›åˆç»“æŸ</option>
          <option value="onFlashStrike" {{#if (eq activity.trigger "onFlashStrike")}}selected{{/if}}>é—ªå‡»â˜ª</option>
          <option value="onDiscard" {{#if (eq activity.trigger "onDiscard")}}selected{{/if}}>ä¸¢å¼ƒâœ¦</option>
        </select>
      </div>

      {{!-- ç›®æ ‡é€‰æ‹© --}}
      <div class="form-group">
        <label>ç›®æ ‡</label>
        <select name="target">
          <option value="selected" {{#if (eq activity.target "selected")}}selected{{/if}}>é€‰æ‹©çš„ç›®æ ‡</option>
          <option value="self" {{#if (eq activity.target "self")}}selected{{/if}}>è‡ªå·±</option>
          <option value="multiple" {{#if (eq activity.target "multiple")}}selected{{/if}}>å¤šä¸ªç›®æ ‡</option>
        </select>
      </div>

      {{!-- å›åˆè®¡æ•°é€‰æ‹© --}}
      <div class="form-group">
        <label>å›åˆ</label>
        <select name="roundTiming">
          <option value="current" {{#unless activity.roundTiming}}selected{{/unless}}{{#if (eq activity.roundTiming "current")}}selected{{/if}}>æœ¬å›åˆ</option>
          <option value="next" {{#if (eq activity.roundTiming "next")}}selected{{/if}}>ä¸‹å›åˆ</option>
          <option value="both" {{#if (eq activity.roundTiming "both")}}selected{{/if}}>æœ¬å›åˆå’Œä¸‹å›åˆ</option>
        </select>
      </div>

      {{!-- æ¶ˆè€—åˆ—è¡¨ --}}
      <div class="form-group">
        <label>
          <input type="checkbox" name="hasConsume" {{#if activity.hasConsume}}checked{{/if}} class="has-consume-checkbox" />
          éœ€è¦æ¶ˆè€—
        </label>
        {{#if activity.hasConsume}}
          <div class="dynamic-list consumes-list">
            {{#each activity.consumes as |consume idx|}}
              <div class="dynamic-row" data-index="{{idx}}">
                <select name="consumes.{{idx}}.buffId">
                  {{#each ../buffPresets as |buff|}}
                    <option value="{{buff.id}}" {{#if (eq buff.id consume.buffId)}}selected{{/if}}>{{buff.name}}</option>
                  {{/each}}
                </select>
                <input type="number" name="consumes.{{idx}}.layers" value="{{consume.layers}}" placeholder="å±‚æ•°" />
                <input type="number" name="consumes.{{idx}}.strength" value="{{consume.strength}}" placeholder="å¼ºåº¦" />
                <button type="button" class="remove-btn remove-consume-btn" data-index="{{idx}}"><i class="fas fa-times"></i></button>
              </div>
            {{/each}}
            <button type="button" class="add-btn add-consume-btn"><i class="fas fa-plus"></i> æ·»åŠ æ¶ˆè€—</button>
          </div>
        {{/if}}
      </div>

      {{!-- æ•ˆæœæ·»åŠ  --}}
      <div class="form-group">
        <label>æ•ˆæœæ·»åŠ </label>
        <div class="dynamic-list effects-list">
          {{#each activity.effectsList as |effect idx|}}
            <div class="dynamic-row" data-index="{{idx}}">
              <select name="effects.{{idx}}.buffId" class="effect-select">
                {{#each ../buffPresets as |buff|}}
                  <option value="{{buff.id}}" {{#if (eq buff.id effect.buffId)}}selected{{/if}}>{{buff.name}}</option>
                {{/each}}
              </select>
              <input type="text" name="effects.{{idx}}.layers" value="{{effect.layers}}" placeholder="å±‚æ•°(å¯ç”¨éª°å­/è¡¨è¾¾å¼)" />
              <input type="text" name="effects.{{idx}}.strength" value="{{effect.strength}}" placeholder="å¼ºåº¦(å¯ç”¨éª°å­/è¡¨è¾¾å¼)" />
              <button type="button" class="remove-btn remove-effect-btn" data-index="{{idx}}"><i class="fas fa-times"></i></button>
            </div>
          {{/each}}
          <button type="button" class="add-btn add-effect-btn"><i class="fas fa-plus"></i> æ·»åŠ æ•ˆæœ</button>
        </div>
      </div>

      {{!-- è‡ªå®šä¹‰æ•ˆæœ --}}
      <div class="form-group">
        <label>
          <input type="checkbox" name="customEffect.enabled" {{#if activity.customEffect.enabled}}checked{{/if}} class="custom-effect-checkbox" />
          å…¶ä»–æ•ˆæœ
        </label>
        {{#if activity.customEffect.enabled}}
          <div class="custom-effect-fields">
            <input type="text" name="customEffect.name" value="{{activity.customEffect.name}}" placeholder="æ•ˆæœåç§°" />
            <input type="text" name="customEffect.layers" value="{{activity.customEffect.layers}}" placeholder="å±‚æ•°(å¯ç”¨éª°å­/è¡¨è¾¾å¼)" />
            <input type="text" name="customEffect.strength" value="{{activity.customEffect.strength}}" placeholder="å¼ºåº¦(å¯ç”¨éª°å­/è¡¨è¾¾å¼)" />
          </div>
        {{/if}}
      </div>

      {{!-- æç¤ºä¿¡æ¯ --}}
      <div class="info-box">
        <i class="fas fa-info-circle"></i>
        <span>ğŸ’¡ æç¤ºï¼šå±‚æ•°å’Œå¼ºåº¦å­—æ®µæ”¯æŒè¡¨è¾¾å¼ï¼Œå¦‚ <code>{literal}{{burn.layers}}{/literal}</code> æˆ– <code>floor({literal}{{burn.layers}}{/literal}/4)</code>ã€‚éœ€è¦å¤æ‚é€»è¾‘ï¼Ÿåˆ‡æ¢åˆ° <strong>é«˜çº§æ¨¡å¼</strong>ï¼</span>
      </div>

    </div>
    {{/if}}

    {{!-- ========== é«˜çº§æ¨¡å¼ (JSON) ========== --}}
    {{#if isAdvancedMode}}
    <div class="tab-content tab-advanced active">

      <div class="json-editor-container">
        <label>JSON ç¼–è¾‘å™¨</label>
        <textarea class="json-editor" rows="20">{{activityJSON}}</textarea>
      </div>

      <div class="json-controls">
        <button type="button" class="validate-json-btn"><i class="fas fa-check-circle"></i> éªŒè¯JSON</button>
        <button type="button" class="format-json-btn"><i class="fas fa-align-left"></i> æ ¼å¼åŒ–</button>
      </div>

      <div class="json-preview">
        <h4>é¢„è§ˆ</h4>
        <div class="preview-content">ç‚¹å‡»"éªŒè¯JSON"æŸ¥çœ‹é¢„è§ˆ</div>
      </div>

    </div>
    {{/if}}

    {{!-- ä¿å­˜å’Œå–æ¶ˆæŒ‰é’® --}}
    <div class="form-actions">
      <button type="button" class="cancel-btn">å–æ¶ˆ</button>
      <button type="submit" class="save-btn">ä¿å­˜</button>
    </div>

  </form>

</div>

<style>
.activity-editor-enhanced {
  font-family: 'Noto Sans SC', sans-serif;
}

.tabs {
  display: flex;
  border-bottom: 2px solid #EBBD68;
  margin-bottom: 16px;
}

.tab-btn {
  flex: 1;
  padding: 12px 24px;
  background: #1a1a1a;
  border: 1px solid #555;
  border-bottom: none;
  color: #ccc;
  cursor: pointer;
  transition: all 0.3s;
  font-size: 14px;
  font-weight: 500;
}

.tab-btn:hover {
  background: #252525;
  color: #fff;
}

.tab-btn.active {
  background: #0F0D1B;
  border-color: #EBBD68;
  color: #EBBD68;
  font-weight: bold;
}

.tab-btn i {
  margin-right: 6px;
}

.tab-content {
  display: none;
  animation: fadeIn 0.3s;
}

.tab-content.active {
  display: block;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

.info-box {
  background: #1a3a5a;
  border-left: 4px solid #4a9eff;
  padding: 12px;
  margin-top: 16px;
  border-radius: 4px;
  display: flex;
  align-items: start;
  gap: 8px;
}

.info-box i {
  color: #4a9eff;
  margin-top: 2px;
}

.info-box code {
  background: rgba(255, 255, 255, 0.1);
  padding: 2px 6px;
  border-radius: 3px;
  font-family: 'Courier New', monospace;
}

.json-editor-container {
  margin-bottom: 16px;
}

.json-editor {
  width: 100%;
  min-height: 400px;
  background: #1a1a1a;
  color: #f0f0f0;
  border: 1px solid #555;
  border-radius: 4px;
  padding: 12px;
  font-family: 'Courier New', monospace;
  font-size: 13px;
  line-height: 1.5;
  resize: vertical;
}

.json-controls {
  display: flex;
  gap: 12px;
  margin-bottom: 16px;
}

.validate-json-btn,
.format-json-btn {
  padding: 8px 16px;
  background: #2a5a8a;
  color: #fff;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  transition: background 0.2s;
}

.validate-json-btn:hover,
.format-json-btn:hover {
  background: #3a7aba;
}

.json-preview {
  background: #0a0a0a;
  border: 1px solid #EBBD68;
  border-radius: 4px;
  padding: 12px;
  margin-bottom: 16px;
}

.json-preview h4 {
  margin-top: 0;
  color: #EBBD68;
}
</style>
