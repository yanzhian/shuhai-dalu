<div class="activity-editor-enhanced">

  {{!-- æ ‡ç­¾é¡µå¯¼èˆª --}}
  <div class="tabs">
    <button class="tab-btn {{#if isBasicMode}}active{{/if}}" data-mode="basic">
      <i class="fas fa-edit"></i> åŸºç¡€ç¼–è¾‘å™¨
    </button>
    <button class="tab-btn {{#if isAdvancedMode}}active{{/if}}" data-mode="advanced">
      <i class="fas fa-code"></i> é«˜çº§æ¨¡å¼ (JSON)
    </button>
  </div>

  <form class="activity-editor-form">

    {{!-- ========== åŸºç¡€ç¼–è¾‘å™¨ ========== --}}
    {{#if isBasicMode}}
    <div class="tab-content tab-basic active">

      {{!-- æ´»åŠ¨åç§° --}}
      <div class="form-group">
        <label>æ´»åŠ¨åç§°</label>
        <input type="text" name="name" value="{{activity.name}}" placeholder="ä¾‹å¦‚ï¼šæ”»å‡»å‘½ä¸­æ—¶-ç‡ƒçƒ§æ•ˆæœ" />
      </div>

      {{!-- è§¦å‘æ—¶æœº --}}
      <div class="form-group">
        <label>è§¦å‘æ—¶æœº</label>
        <select name="trigger">
          <option value="onUse" {{#if (eq activity.trigger "onUse")}}selected{{/if}}>ä½¿ç”¨æ—¶</option>
          <option value="onAttack" {{#if (eq activity.trigger "onAttack")}}selected{{/if}}>æ”»å‡»æ—¶</option>
          <option value="onCounter" {{#if (eq activity.trigger "onCounter")}}selected{{/if}}>å¯¹æŠ—æ—¶</option>
          <option value="onCounterSuccess" {{#if (eq activity.trigger "onCounterSuccess")}}selected{{/if}}>å¯¹æŠ—æˆåŠŸ</option>
          <option value="onCounterFail" {{#if (eq activity.trigger "onCounterFail")}}selected{{/if}}>å¯¹æŠ—å¤±è´¥</option>
          <option value="onHit" {{#if (eq activity.trigger "onHit")}}selected{{/if}}>æ”»å‡»å‘½ä¸­</option>
          <option value="onDamaged" {{#if (eq activity.trigger "onDamaged")}}selected{{/if}}>å—åˆ°ä¼¤å®³</option>
          <option value="onTurnStart" {{#if (eq activity.trigger "onTurnStart")}}selected{{/if}}>å›åˆå¼€å§‹</option>
          <option value="onTurnEnd" {{#if (eq activity.trigger "onTurnEnd")}}selected{{/if}}>å›åˆç»“æŸ</option>
          <option value="onFlashStrike" {{#if (eq activity.trigger "onFlashStrike")}}selected{{/if}}>é—ªå‡»â˜ª</option>
          <option value="onDiscard" {{#if (eq activity.trigger "onDiscard")}}selected{{/if}}>ä¸¢å¼ƒâœ¦</option>
        </select>
      </div>

      {{!-- ç›®æ ‡é€‰æ‹© --}}
      <div class="form-group">
        <label>ç›®æ ‡</label>
        <select name="target">
          <option value="selected" {{#if (eq activity.target "selected")}}selected{{/if}}>é€‰æ‹©çš„ç›®æ ‡</option>
          <option value="self" {{#if (eq activity.target "self")}}selected{{/if}}>è‡ªå·±</option>
          <option value="multiple" {{#if (eq activity.target "multiple")}}selected{{/if}}>å¤šä¸ªç›®æ ‡</option>
        </select>
      </div>

      {{!-- å›åˆè®¡æ•°é€‰æ‹© --}}
      <div class="form-group">
        <label>å›åˆ</label>
        <select name="roundTiming">
          <option value="current" {{#unless activity.roundTiming}}selected{{/unless}}{{#if (eq activity.roundTiming "current")}}selected{{/if}}>æœ¬å›åˆ</option>
          <option value="next" {{#if (eq activity.roundTiming "next")}}selected{{/if}}>ä¸‹å›åˆ</option>
          <option value="both" {{#if (eq activity.roundTiming "both")}}selected{{/if}}>æœ¬å›åˆå’Œä¸‹å›åˆ</option>
        </select>
      </div>

      {{!-- æ¶ˆè€—åˆ—è¡¨ --}}
      <div class="form-group">
        <label>
          <input type="checkbox" name="hasConsume" {{#if activity.hasConsume}}checked{{/if}} class="has-consume-checkbox" />
          éœ€è¦æ¶ˆè€—
        </label>
        {{#if activity.hasConsume}}
          <div class="dynamic-list consumes-list">
            {{#each activity.consumes as |consume idx|}}
              <div class="dynamic-row" data-index="{{idx}}">
                <select name="consumes.{{idx}}.buffId">
                  {{#each ../buffPresets as |buff|}}
                    <option value="{{buff.id}}" {{#if (eq buff.id consume.buffId)}}selected{{/if}}>{{buff.name}}</option>
                  {{/each}}
                </select>
                <input type="number" name="consumes.{{idx}}.layers" value="{{consume.layers}}" placeholder="å±‚æ•°" />
                <input type="number" name="consumes.{{idx}}.strength" value="{{consume.strength}}" placeholder="å¼ºåº¦" />
                <button type="button" class="remove-btn remove-consume-btn" data-index="{{idx}}"><i class="fas fa-times"></i></button>
              </div>
            {{/each}}
            <button type="button" class="add-btn add-consume-btn"><i class="fas fa-plus"></i> æ·»åŠ æ¶ˆè€—</button>
          </div>
        {{/if}}
      </div>

      {{!-- æ•ˆæœåˆ—è¡¨ --}}
      <div class="form-group">
        <label>æ•ˆæœåˆ—è¡¨</label>
        <div class="dynamic-list effects-list">
          {{#each activity.effectsList as |effect idx|}}
            <div class="effect-item" data-index="{{idx}}">

              {{!-- æ•ˆæœç±»å‹é€‰æ‹©å™¨ --}}
              <div class="effect-header">
                <select name="effects.{{idx}}.type" class="effect-type-select" data-index="{{idx}}">
                  {{#each ../effectTypesByCategory as |category|}}
                    <optgroup label="{{category.icon}} {{category.name}}">
                      {{#each category.effects as |effectDef|}}
                        <option value="{{effectDef.id}}" {{#if (eq effectDef.id effect.type)}}selected{{/if}}>{{effectDef.name}}</option>
                      {{/each}}
                    </optgroup>
                  {{/each}}
                </select>
                <button type="button" class="remove-btn remove-effect-btn" data-index="{{idx}}">
                  <i class="fas fa-times"></i>
                </button>
              </div>

              {{!-- åŠ¨æ€å‚æ•°å­—æ®µ --}}
              <div class="effect-params">

                {{!-- addBuff æ•ˆæœ --}}
                {{#if (eq effect.type "addBuff")}}
                  <div class="param-row">
                    <label>BUFF:</label>
                    <select name="effects.{{idx}}.params.buffId">
                      {{#each ../buffPresets as |buff|}}
                        <option value="{{buff.id}}" {{#if (eq buff.id effect.params.buffId)}}selected{{/if}}>{{buff.name}}</option>
                      {{/each}}
                    </select>
                  </div>
                  <div class="param-row">
                    <label>å±‚æ•°:</label>
                    <input type="text" name="effects.{{idx}}.params.layers" value="{{effect.params.layers}}" placeholder="1 æˆ– {charge.layers}" />
                  </div>
                  <div class="param-row">
                    <label>å¼ºåº¦:</label>
                    <input type="text" name="effects.{{idx}}.params.strength" value="{{effect.params.strength}}" placeholder="0" />
                  </div>
                  <div class="param-row">
                    <label>ç›®æ ‡:</label>
                    <select name="effects.{{idx}}.params.target">
                      {{#each ../targetOptions as |opt|}}
                        <option value="{{opt.value}}" {{#if (eq opt.value effect.params.target)}}selected{{/if}}>{{opt.label}}</option>
                      {{/each}}
                    </select>
                  </div>
                {{/if}}

                {{!-- consumeBuff æ•ˆæœ --}}
                {{#if (eq effect.type "consumeBuff")}}
                  <div class="param-row">
                    <label>BUFF:</label>
                    <select name="effects.{{idx}}.params.buffId">
                      {{#each ../buffPresets as |buff|}}
                        <option value="{{buff.id}}" {{#if (eq buff.id effect.params.buffId)}}selected{{/if}}>{{buff.name}}</option>
                      {{/each}}
                    </select>
                  </div>
                  <div class="param-row">
                    <label>å±‚æ•°:</label>
                    <input type="text" name="effects.{{idx}}.params.layers" value="{{effect.params.layers}}" placeholder="1" />
                  </div>
                  <div class="param-row">
                    <label>ç›®æ ‡:</label>
                    <select name="effects.{{idx}}.params.target">
                      {{#each ../targetOptions as |opt|}}
                        <option value="{{opt.value}}" {{#if (eq opt.value effect.params.target)}}selected{{/if}}>{{opt.label}}</option>
                      {{/each}}
                    </select>
                  </div>
                {{/if}}

                {{!-- diceModifier æ•ˆæœ --}}
                {{#if (eq effect.type "diceModifier")}}
                  <div class="param-row">
                    <label>ä¿®æ­£å€¼:</label>
                    <input type="text" name="effects.{{idx}}.params.modifier" value="{{effect.params.modifier}}" placeholder="+3 æˆ– +{charge.layers}" />
                  </div>
                {{/if}}

                {{!-- dealDamage æ•ˆæœ --}}
                {{#if (eq effect.type "dealDamage")}}
                  <div class="param-row">
                    <label>ä¼¤å®³:</label>
                    <input type="text" name="effects.{{idx}}.params.amount" value="{{effect.params.amount}}" placeholder="5 æˆ– {strength}" />
                  </div>
                  <div class="param-row">
                    <label>ç›®æ ‡:</label>
                    <select name="effects.{{idx}}.params.target">
                      {{#each ../targetOptions as |opt|}}
                        <option value="{{opt.value}}" {{#if (eq opt.value effect.params.target)}}selected{{/if}}>{{opt.label}}</option>
                      {{/each}}
                    </select>
                  </div>
                  <div class="param-row">
                    <label>ç±»å‹:</label>
                    <select name="effects.{{idx}}.params.type">
                      {{#each ../damageTypeOptions as |opt|}}
                        <option value="{{opt.value}}" {{#if (eq opt.value effect.params.type)}}selected{{/if}}>{{opt.label}}</option>
                      {{/each}}
                    </select>
                  </div>
                {{/if}}

                {{!-- healHealth æ•ˆæœ --}}
                {{#if (eq effect.type "healHealth")}}
                  <div class="param-row">
                    <label>æ¢å¤é‡:</label>
                    <input type="text" name="effects.{{idx}}.params.amount" value="{{effect.params.amount}}" placeholder="10 æˆ– 1d8" />
                  </div>
                  <div class="param-row">
                    <label>ç›®æ ‡:</label>
                    <select name="effects.{{idx}}.params.target">
                      {{#each ../targetOptions as |opt|}}
                        <option value="{{opt.value}}" {{#if (eq opt.value effect.params.target)}}selected{{/if}}>{{opt.label}}</option>
                      {{/each}}
                    </select>
                  </div>
                {{/if}}

                {{!-- restoreCost / consumeCost æ•ˆæœ --}}
                {{#if (or (eq effect.type "restoreCost") (eq effect.type "consumeCost"))}}
                  <div class="param-row">
                    <label>æ•°é‡:</label>
                    <input type="text" name="effects.{{idx}}.params.amount" value="{{effect.params.amount}}" placeholder="1" />
                  </div>
                {{/if}}

                {{!-- å…¶ä»–æ•ˆæœç±»å‹ - æ˜¾ç¤ºé€šç”¨æç¤º --}}
                {{#unless (or (eq effect.type "addBuff") (eq effect.type "consumeBuff") (eq effect.type "diceModifier") (eq effect.type "dealDamage") (eq effect.type "healHealth") (eq effect.type "restoreCost") (eq effect.type "consumeCost"))}}
                  <div class="param-hint">
                    <i class="fas fa-info-circle"></i>
                    æ­¤æ•ˆæœç±»å‹éœ€è¦ä½¿ç”¨é«˜çº§æ¨¡å¼(JSON)è¿›è¡Œé…ç½®
                  </div>
                {{/unless}}

              </div>
            </div>
          {{/each}}
          <button type="button" class="add-btn add-effect-btn"><i class="fas fa-plus"></i> æ·»åŠ æ•ˆæœ</button>
        </div>
      </div>

      {{!-- æç¤ºä¿¡æ¯ --}}
      <div class="info-box">
        <i class="fas fa-info-circle"></i>
        <span>ğŸ’¡ æç¤ºï¼šæ•°å€¼å­—æ®µæ”¯æŒè¡¨è¾¾å¼ï¼Œå¦‚ <code>{literal}{{burn.layers}}{/literal}</code> æˆ– <code>floor({literal}{{charge.layers}}{/literal}/4)</code>ã€‚éœ€è¦æ›´å¤šæ•ˆæœç±»å‹ï¼Ÿåˆ‡æ¢åˆ° <strong>é«˜çº§æ¨¡å¼(JSON)</strong>ï¼</span>
      </div>

    </div>
    {{/if}}

    {{!-- ========== é«˜çº§æ¨¡å¼ (JSON) ========== --}}
    {{#if isAdvancedMode}}
    <div class="tab-content tab-advanced active">

      <div class="json-editor-container">
        <label>JSON ç¼–è¾‘å™¨</label>
        <textarea class="json-editor" rows="20">{{activityJSON}}</textarea>
      </div>

      <div class="json-controls">
        <button type="button" class="validate-json-btn"><i class="fas fa-check-circle"></i> éªŒè¯JSON</button>
        <button type="button" class="format-json-btn"><i class="fas fa-align-left"></i> æ ¼å¼åŒ–</button>
      </div>

      <div class="json-preview">
        <h4>é¢„è§ˆ</h4>
        <div class="preview-content">ç‚¹å‡»"éªŒè¯JSON"æŸ¥çœ‹é¢„è§ˆ</div>
      </div>

    </div>
    {{/if}}

    {{!-- ä¿å­˜å’Œå–æ¶ˆæŒ‰é’® --}}
    <div class="form-actions">
      <button type="button" class="cancel-btn">å–æ¶ˆ</button>
      <button type="submit" class="save-btn">ä¿å­˜</button>
    </div>

  </form>

</div>

<style>
.activity-editor-enhanced {
  font-family: 'Noto Sans SC', sans-serif;
}

.tabs {
  display: flex;
  border-bottom: 2px solid #EBBD68;
  margin-bottom: 16px;
}

.tab-btn {
  flex: 1;
  padding: 12px 24px;
  background: #1a1a1a;
  border: 1px solid #555;
  border-bottom: none;
  color: #ccc;
  cursor: pointer;
  transition: all 0.3s;
  font-size: 14px;
  font-weight: 500;
}

.tab-btn:hover {
  background: #252525;
  color: #fff;
}

.tab-btn.active {
  background: #0F0D1B;
  border-color: #EBBD68;
  color: #EBBD68;
  font-weight: bold;
}

.tab-btn i {
  margin-right: 6px;
}

.tab-content {
  display: none;
  animation: fadeIn 0.3s;
}

.tab-content.active {
  display: block;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

.info-box {
  background: #1a3a5a;
  border-left: 4px solid #4a9eff;
  padding: 12px;
  margin-top: 16px;
  border-radius: 4px;
  display: flex;
  align-items: start;
  gap: 8px;
}

.info-box i {
  color: #4a9eff;
  margin-top: 2px;
}

.info-box code {
  background: rgba(255, 255, 255, 0.1);
  padding: 2px 6px;
  border-radius: 3px;
  font-family: 'Courier New', monospace;
}

.json-editor-container {
  margin-bottom: 16px;
}

.json-editor {
  width: 100%;
  min-height: 400px;
  background: #1a1a1a;
  color: #f0f0f0;
  border: 1px solid #555;
  border-radius: 4px;
  padding: 12px;
  font-family: 'Courier New', monospace;
  font-size: 13px;
  line-height: 1.5;
  resize: vertical;
}

.json-controls {
  display: flex;
  gap: 12px;
  margin-bottom: 16px;
}

.validate-json-btn,
.format-json-btn {
  padding: 8px 16px;
  background: #2a5a8a;
  color: #fff;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  transition: background 0.2s;
}

.validate-json-btn:hover,
.format-json-btn:hover {
  background: #3a7aba;
}

.json-preview {
  background: #0a0a0a;
  border: 1px solid #EBBD68;
  border-radius: 4px;
  padding: 12px;
  margin-bottom: 16px;
}

.json-preview h4 {
  margin-top: 0;
  color: #EBBD68;
}

/* æ•ˆæœé¡¹æ ·å¼ */
.effect-item {
  background: #1a1a1a;
  border: 1px solid #444;
  border-radius: 6px;
  padding: 12px;
  margin-bottom: 12px;
}

.effect-header {
  display: flex;
  gap: 8px;
  margin-bottom: 12px;
}

.effect-type-select {
  flex: 1;
  padding: 8px 12px;
  background: #2a2a2a;
  border: 1px solid #555;
  border-radius: 4px;
  color: #f0f0f0;
  font-size: 14px;
  font-weight: 500;
}

.effect-params {
  display: flex;
  flex-direction: column;
  gap: 8px;
  padding-left: 12px;
  border-left: 3px solid #EBBD68;
}

.param-row {
  display: flex;
  align-items: center;
  gap: 8px;
}

.param-row label {
  min-width: 80px;
  font-size: 13px;
  color: #ccc;
}

.param-row input,
.param-row select {
  flex: 1;
  padding: 6px 10px;
  background: #0a0a0a;
  border: 1px solid #555;
  border-radius: 3px;
  color: #f0f0f0;
  font-size: 13px;
}

.param-row input:focus,
.param-row select:focus {
  border-color: #EBBD68;
  outline: none;
}

.param-hint {
  padding: 8px 12px;
  background: rgba(235, 189, 104, 0.1);
  border: 1px dashed #EBBD68;
  border-radius: 4px;
  color: #EBBD68;
  font-size: 12px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.param-hint i {
  color: #EBBD68;
}
</style>
