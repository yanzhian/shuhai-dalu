<div class="condition-editor">

  {{!-- 触发时机（单选） --}}
  <div class="trigger-timing-section">
    <div class="timing-options">
      <label class="timing-option {{#if (eq condition.trigger 'onUse')}}selected{{/if}}">
        <input type="radio" name="system.conditions.{{index}}.trigger" value="onUse" {{#if (eq condition.trigger 'onUse')}}checked{{/if}} {{#if locked}}disabled{{/if}} />
        <span>使用时</span>
      </label>
      <label class="timing-option {{#if (eq condition.trigger 'onAttack')}}selected{{/if}}">
        <input type="radio" name="system.conditions.{{index}}.trigger" value="onAttack" {{#if (eq condition.trigger 'onAttack')}}checked{{/if}} {{#if locked}}disabled{{/if}} />
        <span>攻击时</span>
      </label>
      <label class="timing-option {{#if (eq condition.trigger 'onCounter')}}selected{{/if}}">
        <input type="radio" name="system.conditions.{{index}}.trigger" value="onCounter" {{#if (eq condition.trigger 'onCounter')}}checked{{/if}} {{#if locked}}disabled{{/if}} />
        <span>对抗时</span>
      </label>
      <label class="timing-option {{#if (eq condition.trigger 'onCounterSuccess')}}selected{{/if}}">
        <input type="radio" name="system.conditions.{{index}}.trigger" value="onCounterSuccess" {{#if (eq condition.trigger 'onCounterSuccess')}}checked{{/if}} {{#if locked}}disabled{{/if}} />
        <span>对抗成功</span>
      </label>
      <label class="timing-option {{#if (eq condition.trigger 'onCounterFail')}}selected{{/if}}">
        <input type="radio" name="system.conditions.{{index}}.trigger" value="onCounterFail" {{#if (eq condition.trigger 'onCounterFail')}}checked{{/if}} {{#if locked}}disabled{{/if}} />
        <span>对抗失败</span>
      </label>
      <label class="timing-option {{#if (eq condition.trigger 'onHit')}}selected{{/if}}">
        <input type="radio" name="system.conditions.{{index}}.trigger" value="onHit" {{#if (eq condition.trigger 'onHit')}}checked{{/if}} {{#if locked}}disabled{{/if}} />
        <span>攻击命中</span>
      </label>
      <label class="timing-option {{#if (eq condition.trigger 'onDamaged')}}selected{{/if}}">
        <input type="radio" name="system.conditions.{{index}}.trigger" value="onDamaged" {{#if (eq condition.trigger 'onDamaged')}}checked{{/if}} {{#if locked}}disabled{{/if}} />
        <span>受到伤害</span>
      </label>
      <label class="timing-option {{#if (eq condition.trigger 'onTurnStart')}}selected{{/if}}">
        <input type="radio" name="system.conditions.{{index}}.trigger" value="onTurnStart" {{#if (eq condition.trigger 'onTurnStart')}}checked{{/if}} {{#if locked}}disabled{{/if}} />
        <span>回合开始</span>
      </label>
      <label class="timing-option {{#if (eq condition.trigger 'onTurnEnd')}}selected{{/if}}">
        <input type="radio" name="system.conditions.{{index}}.trigger" value="onTurnEnd" {{#if (eq condition.trigger 'onTurnEnd')}}checked{{/if}} {{#if locked}}disabled{{/if}} />
        <span>回合结束</span>
      </label>
    </div>
  </div>

  <div class="section-divider"></div>

  {{!-- 消耗开关 --}}
  <div class="consume-section">
    <label class="consume-toggle {{#if condition.hasConsume}}active{{/if}}">
      <input type="checkbox" name="system.conditions.{{index}}.hasConsume" {{#if condition.hasConsume}}checked{{/if}} {{#if locked}}disabled{{/if}} class="consume-checkbox" />
      <span>消耗</span>
    </label>

    {{!-- 消耗列表 --}}
    {{#if condition.hasConsume}}
      <div class="consumes-list">
        {{#each condition.consumes as |consume consumeIndex|}}
          <div class="consume-item" data-consume-index="{{consumeIndex}}">
            <select name="system.conditions.{{../index}}.consumes.{{consumeIndex}}.buffId" {{#if ../locked}}disabled{{/if}} class="consume-effect-select">
              {{#each ../../buffPresets as |buff|}}
                <option value="{{buff.id}}" {{#if (eq buff.id ../consume.buffId)}}selected{{/if}}>{{buff.name}}</option>
              {{/each}}
            </select>
            <input type="number" name="system.conditions.{{../index}}.consumes.{{consumeIndex}}.layers" value="{{consume.layers}}" placeholder="层数" {{#if ../locked}}disabled{{/if}} class="consume-layers-input" />
            <span class="consume-unit">层数</span>
            <input type="number" name="system.conditions.{{../index}}.consumes.{{consumeIndex}}.strength" value="{{consume.strength}}" placeholder="强度" {{#if ../locked}}disabled{{/if}} class="consume-strength-input" />
            <span class="consume-unit">强度</span>
            {{#unless ../locked}}
              <button type="button" class="remove-consume-btn" data-condition-index="{{../index}}" data-consume-index="{{consumeIndex}}">
                <i class="fas fa-times"></i>
              </button>
            {{/unless}}
          </div>
        {{/each}}
        {{#unless locked}}
          <button type="button" class="add-consume-btn" data-condition-index="{{index}}">
            <i class="fas fa-plus"></i>
            添加消耗
          </button>
        {{/unless}}
      </div>
    {{/if}}
  </div>

  <div class="section-divider"></div>

  {{!-- 目标选择（单选） --}}
  <div class="target-section">
    <span class="section-label">目标</span>
    <div class="target-options">
      <label class="target-option {{#if (eq condition.target 'selected')}}selected{{/if}}">
        <input type="radio" name="system.conditions.{{index}}.target" value="selected" {{#if (eq condition.target 'selected')}}checked{{/if}} {{#if locked}}disabled{{/if}} />
        <span>选择的目标</span>
      </label>
      <label class="target-option {{#if (eq condition.target 'self')}}selected{{/if}}">
        <input type="radio" name="system.conditions.{{index}}.target" value="self" {{#if (eq condition.target 'self')}}checked{{/if}} {{#if locked}}disabled{{/if}} />
        <span>自己</span>
      </label>
      <label class="target-option {{#if (eq condition.target 'multiple')}}selected{{/if}}">
        <input type="radio" name="system.conditions.{{index}}.target" value="multiple" {{#if (eq condition.target 'multiple')}}checked{{/if}} {{#if locked}}disabled{{/if}} />
        <span>多个目标</span>
      </label>
    </div>
  </div>

  <div class="section-divider"></div>

  {{!-- 回合计数选择（单选） --}}
  <div class="round-timing-section">
    <span class="section-label">回合</span>
    <div class="round-timing-options">
      <label class="round-timing-option {{#unless condition.roundTiming}}selected{{/unless}}{{#if (eq condition.roundTiming 'current')}}selected{{/if}}">
        <input type="radio" name="system.conditions.{{index}}.roundTiming" value="current" {{#unless condition.roundTiming}}checked{{/unless}}{{#if (eq condition.roundTiming 'current')}}checked{{/if}} {{#if locked}}disabled{{/if}} />
        <span>本回合</span>
      </label>
      <label class="round-timing-option {{#if (eq condition.roundTiming 'next')}}selected{{/if}}">
        <input type="radio" name="system.conditions.{{index}}.roundTiming" value="next" {{#if (eq condition.roundTiming 'next')}}checked{{/if}} {{#if locked}}disabled{{/if}} />
        <span>下回合</span>
      </label>
      <label class="round-timing-option {{#if (eq condition.roundTiming 'both')}}selected{{/if}}">
        <input type="radio" name="system.conditions.{{index}}.roundTiming" value="both" {{#if (eq condition.roundTiming 'both')}}checked{{/if}} {{#if locked}}disabled{{/if}} />
        <span>本回合和下回合</span>
      </label>
    </div>
  </div>

  <div class="section-divider"></div>

  {{!-- 效果添加标题 --}}
  <div class="effects-section">
    <div class="section-title">效果添加</div>

    {{!-- 效果列表（多选） --}}
    <div class="effects-list">
      {{#each buffPresets as |buff|}}
        <label class="effect-item {{#if (lookup ../../condition.effects buff.id)}}selected{{/if}}">
          <input type="checkbox" name="system.conditions.{{../index}}.effects.{{buff.id}}.enabled" {{#if (lookup ../../condition.effects buff.id)}}checked{{/if}} {{#if ../../locked}}disabled{{/if}} class="effect-checkbox" />
          <span class="effect-name">{{buff.name}}</span>
          <input type="number" name="system.conditions.{{../index}}.effects.{{buff.id}}.layers" value="{{#if (lookup ../../condition.effects buff.id)}}{{lookup (lookup ../../condition.effects buff.id) 'layers'}}{{else}}{{buff.defaultLayers}}{{/if}}" placeholder="层数" {{#if ../../locked}}disabled{{/if}} class="effect-layers-input" />
          <span class="effect-unit">层数</span>
          <input type="number" name="system.conditions.{{../index}}.effects.{{buff.id}}.strength" value="{{#if (lookup ../../condition.effects buff.id)}}{{lookup (lookup ../../condition.effects buff.id) 'strength'}}{{else}}{{buff.defaultStrength}}{{/if}}" placeholder="强度" {{#if ../../locked}}disabled{{/if}} class="effect-strength-input" />
          <span class="effect-unit">强度</span>
        </label>
      {{/each}}
    </div>
  </div>

  <div class="section-divider"></div>

  {{!-- 基础效果（自定义效果） --}}
  <div class="custom-effect-section">
    <div class="section-title">其他效果</div>
    <label class="effect-item {{#if condition.customEffect.enabled}}selected{{/if}}">
      <input type="checkbox" name="system.conditions.{{index}}.customEffect.enabled" {{#if condition.customEffect.enabled}}checked{{/if}} {{#if locked}}disabled{{/if}} class="effect-checkbox" />
      <span class="effect-name">自定义</span>
      <input type="text" name="system.conditions.{{index}}.customEffect.name" value="{{condition.customEffect.name}}" placeholder="效果名称" {{#if locked}}disabled{{/if}} class="custom-effect-name-input" />
      <input type="number" name="system.conditions.{{index}}.customEffect.layers" value="{{condition.customEffect.layers}}" placeholder="层数" {{#if locked}}disabled{{/if}} class="effect-layers-input" />
      <span class="effect-unit">层数</span>
      <input type="number" name="system.conditions.{{index}}.customEffect.strength" value="{{condition.customEffect.strength}}" placeholder="强度" {{#if locked}}disabled{{/if}} class="effect-strength-input" />
      <span class="effect-unit">强度</span>
    </label>
  </div>

  {{!-- 保存按钮 --}}
  {{#unless locked}}
    <div class="condition-save-section">
      <button type="button" class="save-condition-btn" data-condition-index="{{index}}">
        <i class="fas fa-save"></i>
        保存条件
      </button>
    </div>
  {{/unless}}

</div>
