<form class="{{cssClass}} player-sheet flexcol" autocomplete="off">

  {{!-- 整体容器 --}}
  <div class="sheet-container">

    {{!-- 左侧栏 --}}
    <div class="left-column">

      {{!-- 头像容器 --}}
      <div class="avatar-container">
        <img class="profile-img" src="{{actor.img}}" data-edit="img" title="{{actor.name}}"/>
        <button class="lock-btn {{#if isLocked}}locked{{/if}}" title="{{#if isLocked}}点击解锁（编辑模式）{{else}}点击锁定（游玩模式）{{/if}}" type="button">
          <i class="fas {{#if isLocked}}fa-lock{{else}}fa-lock-open{{/if}}"></i>
        </button>
      </div>

      {{!-- 状态值区域 --}}
      <div class="status-values-container">
        {{!-- 生命值 --}}
        <div class="status-bar hp-bar">
          <div class="bar-fill hp" style="width: {{multiply (divide system.derived.hp.value system.derived.hp.max) 100}}%"></div>
          <span class="bar-text">{{system.derived.hp.value}}/{{system.derived.hp.max}}</span>
        </div>

        {{!-- 侵蚀度和混乱值 --}}
        <div class="dual-status-row">
          <div class="status-bar erosion-bar">
            <div class="bar-fill erosion" style="width: {{multiply (divide system.derived.corruption.value system.derived.corruption.max) 100}}%"></div>
            <span class="bar-text">{{system.derived.corruption.value}}/{{system.derived.corruption.max}}</span>
          </div>

          <div class="status-bar chaos-bar">
            <div class="bar-fill chaos" style="width: {{multiply (divide system.derived.chaos.value system.derived.chaos.max) 100}}%"></div>
            <span class="bar-text">{{system.derived.chaos.value}}/{{system.derived.chaos.max}}</span>
          </div>
        </div>
      </div>

      {{!-- 技能鉴定和装备栏滚动区域 --}}
      <div class="left-scroll-area">

        {{!-- 技能鉴定 --}}
        <div class="skills-check-section">
          <div class="section-header">
            <span class="divider-line"></span>
            <span class="header-text">技能鉴定</span>
            <span class="divider-line"></span>
          </div>

          <div class="skills-check-grid">
            {{!-- 力敏系 --}}
            <div class="skill-category">
              <div class="category-header">
                <span class="category-name">力敏剩余点数</span>
                <span class="remaining-points">{{subtract system.skillPoints.strengthDex.total system.skillPoints.strengthDex.used}}</span>
              </div>
              {{#each skillGroups.strengthDex as |skill key|}}
              <div class="skill-row">
                <button class="skill-btn minus" data-skill="{{key}}" data-category="strengthDex" type="button">-</button>
                <span class="skill-name">{{skill.label}}</span>
                <span class="skill-value">{{skill.value}}</span>
                <button class="skill-btn plus" data-skill="{{key}}" data-category="strengthDex" type="button">+</button>
                <button class="skill-check-btn" data-skill="{{key}}" type="button"></button>
              </div>
              {{/each}}
            </div>

            {{!-- 魅力系 --}}
            <div class="skill-category">
              <div class="category-header">
                <span class="category-name">魅力剩余点数</span>
                <span class="remaining-points">{{subtract system.skillPoints.charisma.total system.skillPoints.charisma.used}}</span>
              </div>
              {{#each skillGroups.charisma as |skill key|}}
              <div class="skill-row">
                <button class="skill-btn minus" data-skill="{{key}}" data-category="charisma" type="button">-</button>
                <span class="skill-name">{{skill.label}}</span>
                <span class="skill-value">{{skill.value}}</span>
                <button class="skill-btn plus" data-skill="{{key}}" data-category="charisma" type="button">+</button>
                <button class="skill-check-btn" data-skill="{{key}}" type="button"></button>
              </div>
              {{/each}}
            </div>

            {{!-- 感知系 --}}
            <div class="skill-category">
              <div class="category-header">
                <span class="category-name">感知剩余点数</span>
                <span class="remaining-points">{{subtract system.skillPoints.perception.total system.skillPoints.perception.used}}</span>
              </div>
              {{#each skillGroups.perception as |skill key|}}
              <div class="skill-row">
                <button class="skill-btn minus" data-skill="{{key}}" data-category="perception" type="button">-</button>
                <span class="skill-name">{{skill.label}}</span>
                <span class="skill-value">{{skill.value}}</span>
                <button class="skill-btn plus" data-skill="{{key}}" data-category="perception" type="button">+</button>
                <button class="skill-check-btn" data-skill="{{key}}" type="button"></button>
              </div>
              {{/each}}
            </div>

            {{!-- 智力系 --}}
            <div class="skill-category">
              <div class="category-header">
                <span class="category-name">智力剩余点数</span>
                <span class="remaining-points">{{subtract system.skillPoints.intelligence.total system.skillPoints.intelligence.used}}</span>
              </div>
              {{#each skillGroups.intelligence as |skill key|}}
              <div class="skill-row">
                <button class="skill-btn minus" data-skill="{{key}}" data-category="intelligence" type="button">-</button>
                <span class="skill-name">{{skill.label}}</span>
                <span class="skill-value">{{skill.value}}</span>
                <button class="skill-btn plus" data-skill="{{key}}" data-category="intelligence" type="button">+</button>
                <button class="skill-check-btn" data-skill="{{key}}" type="button"></button>
              </div>
              {{/each}}
            </div>
          </div>
        </div>

        {{!-- 装备栏 --}}
        <div class="equipment-section">
          <div class="section-header">
            <span class="divider-line"></span>
            <span class="header-text">装备栏</span>
            <span class="divider-line"></span>
          </div>

          {{!-- 第一排：武器、防具 --}}
          <div class="equipment-row">
            <div class="equipment-slot" data-slot="weapon">
              {{#if (hasItem system.equipment.weapon)}}
                <img src="{{getItemImg system.equipment.weapon}}" class="item-icon"/>
                <span class="slot-cost">{{getItemCost system.equipment.weapon}}</span>
                <button class="unequip-btn" data-slot-type="weapon" type="button">卸下</button>
                {{#if (getItemDice system.equipment.weapon)}}
                <span class="slot-dice">{{getItemDice system.equipment.weapon}}</span>
                {{/if}}
              {{else}}
                <span class="slot-label">武器</span>
              {{/if}}
            </div>

            <div class="equipment-slot" data-slot="armor">
              {{#if (hasItem system.equipment.armor)}}
                <img src="{{getItemImg system.equipment.armor}}" class="item-icon"/>
                <span class="slot-cost">{{getItemCost system.equipment.armor}}</span>
                <button class="unequip-btn" data-slot-type="armor" type="button">卸下</button>
                {{#if (getItemDice system.equipment.armor)}}
                <span class="slot-dice">{{getItemDice system.equipment.armor}}</span>
                {{/if}}
              {{else}}
                <span class="slot-label">防具</span>
              {{/if}}
            </div>
          </div>

          {{!-- 第二排：战斗骰1-3 --}}
          <div class="equipment-row">
            {{#each (slice system.equipment.combatDice 0 3) as |diceId index|}}
            <div class="equipment-slot" data-slot="combatDice" data-index="{{index}}">
              {{#if (hasItem diceId)}}
                <img src="{{getItemImg diceId}}" class="item-icon"/>
                <span class="slot-cost">{{getItemCost diceId}}</span>
                <button class="unequip-btn" data-slot-type="combatDice" data-slot-index="{{index}}" type="button">卸下</button>
                {{#if (getItemDice diceId)}}
                <span class="slot-dice">{{getItemDice diceId}}</span>
                {{/if}}
              {{else}}
                <span class="slot-label">战斗骰{{add index 1}}</span>
              {{/if}}
            </div>
            {{/each}}
          </div>

          {{!-- 第三排：战斗骰4-6 --}}
          <div class="equipment-row">
            {{#each (slice system.equipment.combatDice 3 6) as |diceId index|}}
            <div class="equipment-slot" data-slot="combatDice" data-index="{{add index 3}}">
              {{#if (hasItem diceId)}}
                <img src="{{getItemImg diceId}}" class="item-icon"/>
                <span class="slot-cost">{{getItemCost diceId}}</span>
                <button class="unequip-btn" data-slot-type="combatDice" data-slot-index="{{add index 3}}" type="button">卸下</button>
                {{#if (getItemDice diceId)}}
                <span class="slot-dice">{{getItemDice diceId}}</span>
                {{/if}}
              {{else}}
                <span class="slot-label">战斗骰{{add index 4}}</span>
              {{/if}}
            </div>
            {{/each}}
          </div>

          {{!-- 第四排：守备骰、触发骰 --}}
          <div class="equipment-row">
            <div class="equipment-slot" data-slot="defenseDice">
              {{#if (hasItem system.equipment.defenseDice)}}
                <img src="{{getItemImg system.equipment.defenseDice}}" class="item-icon"/>
                <span class="slot-cost">{{getItemCost system.equipment.defenseDice}}</span>
                <button class="unequip-btn" data-slot-type="defenseDice" type="button">卸下</button>
                {{#if (getItemDice system.equipment.defenseDice)}}
                <span class="slot-dice">{{getItemDice system.equipment.defenseDice}}</span>
                {{/if}}
              {{else}}
                <span class="slot-label">守备骰</span>
              {{/if}}
            </div>

            <div class="equipment-slot" data-slot="triggerDice">
              {{#if (hasItem system.equipment.triggerDice)}}
                <img src="{{getItemImg system.equipment.triggerDice}}" class="item-icon"/>
                <span class="slot-cost">{{getItemCost system.equipment.triggerDice}}</span>
                <button class="unequip-btn" data-slot-type="triggerDice" type="button">卸下</button>
                {{#if (getItemDice system.equipment.triggerDice)}}
                <span class="slot-dice">{{getItemDice system.equipment.triggerDice}}</span>
                {{/if}}
              {{else}}
                <span class="slot-label">触发骰</span>
              {{/if}}
            </div>
          </div>

          {{!-- 第五排：被动骰1-3 --}}
          <div class="equipment-row">
            {{#each (slice system.equipment.passives 0 3) as |passiveId index|}}
            <div class="equipment-slot" data-slot="passiveDice" data-index="{{index}}">
              {{#if (hasItem passiveId)}}
                <img src="{{getItemImg passiveId}}" class="item-icon"/>
                <span class="slot-cost">{{getItemCost passiveId}}</span>
                <button class="unequip-btn" data-slot-type="passiveDice" data-slot-index="{{index}}" type="button">卸下</button>
                {{#if (getItemDice passiveId)}}
                <span class="slot-dice">{{getItemDice passiveId}}</span>
                {{/if}}
              {{else}}
                <span class="slot-label">被动骰{{add index 1}}</span>
              {{/if}}
            </div>
            {{/each}}
          </div>

          {{!-- 第六排：被动骰4-6 --}}
          <div class="equipment-row">
            {{#each (slice system.equipment.passives 3 6) as |passiveId index|}}
            <div class="equipment-slot" data-slot="passiveDice" data-index="{{add index 3}}">
              {{#if (hasItem passiveId)}}
                <img src="{{getItemImg passiveId}}" class="item-icon"/>
                <span class="slot-cost">{{getItemCost passiveId}}</span>
                <button class="unequip-btn" data-slot-type="passiveDice" data-slot-index="{{add index 3}}" type="button">卸下</button>
                {{#if (getItemDice passiveId)}}
                <span class="slot-dice">{{getItemDice passiveId}}</span>
                {{/if}}
              {{else}}
                <span class="slot-label">被动骰{{add index 4}}</span>
              {{/if}}
            </div>
            {{/each}}
          </div>

          {{!-- 第七排：装备1-2 --}}
          <div class="equipment-row">
            {{#each (slice system.equipment.gear 0 2) as |gearId index|}}
            <div class="equipment-slot" data-slot="gear" data-index="{{index}}">
              {{#if (hasItem gearId)}}
                <img src="{{getItemImg gearId}}" class="item-icon"/>
                <span class="slot-cost">{{getItemCost gearId}}</span>
                <button class="unequip-btn" data-slot-type="gear" data-slot-index="{{index}}" type="button">卸下</button>
                {{#if (getItemDice gearId)}}
                <span class="slot-dice">{{getItemDice gearId}}</span>
                {{/if}}
              {{else}}
                <span class="slot-label">装备{{add index 1}}</span>
              {{/if}}
            </div>
            {{/each}}
          </div>

          {{!-- 第八排：装备3-4 --}}
          <div class="equipment-row">
            {{#each (slice system.equipment.gear 2 4) as |gearId index|}}
            <div class="equipment-slot" data-slot="gear" data-index="{{add index 2}}">
              {{#if (hasItem gearId)}}
                <img src="{{getItemImg gearId}}" class="item-icon"/>
                <span class="slot-cost">{{getItemCost gearId}}</span>
                <button class="unequip-btn" data-slot-type="gear" data-slot-index="{{add index 2}}" type="button">卸下</button>
                {{#if (getItemDice gearId)}}
                <span class="slot-dice">{{getItemDice gearId}}</span>
                {{/if}}
              {{else}}
                <span class="slot-label">装备{{add index 3}}</span>
              {{/if}}
            </div>
            {{/each}}
          </div>
        </div>
      </div>

      {{!-- 资源区域 --}}
      <div class="resources-section">
        <div class="section-header">
          <span class="divider-line"></span>
          <span class="header-text">资源</span>
          <span class="divider-line"></span>
        </div>

        <div class="resources-grid">
          <div class="resource-item">
            <span class="resource-label">星光</span>
            <span class="resource-value">{{system.derived.starlight}}/{{add 10 (multiply system.level 2)}}</span>
          </div>
          <div class="resource-item">
            <span class="resource-label">货币</span>
            <span class="resource-value">{{system.resources.currency}}</span>
          </div>
          <div class="resource-item">
            <span class="resource-label">奇遇点</span>
            <span class="resource-value">{{system.resources.encounterPoints}}</span>
          </div>
          <div class="resource-item">
            <span class="resource-label">奇迹点</span>
            <span class="resource-value">{{system.resources.miraclePoints}}</span>
          </div>
          <div class="resource-item">
            <span class="resource-label">复制核心</span>
            <span class="resource-value">{{system.resources.replicaCore}}</span>
          </div>
        </div>
      </div>
    </div>

    {{!-- 右侧栏 --}}
    <div class="right-column">

      {{!-- 顶部控制栏 --}}
      <div class="top-controls">
        <button class="top-btn sheet-config-btn" type="button" title="卡模板">
          <i class="fas fa-portrait"></i>
        </button>
        <button class="top-btn token-config-btn" type="button" title="指示物">
          <i class="fas fa-user-circle"></i>
        </button>
        <button class="top-btn close-btn" type="button" title="关闭">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="divider-line-full"></div>

      {{!-- 角色信息 --}}
      <div class="character-info">
        <div class="character-info-left">
          <div class="player-name">
            <input type="text" name="name" value="{{actor.name}}" {{#if isLocked}}disabled{{/if}}/>
          </div>
          <div class="character-details">
            <input type="text" name="system.info.race" value="{{system.info.race}}" placeholder="种族" {{#if isLocked}}disabled{{/if}}/>
            <input type="text" name="system.info.gender" value="{{system.info.gender}}" placeholder="性别" {{#if isLocked}}disabled{{/if}}/>
            <input type="text" name="system.info.job" value="{{system.info.job}}" placeholder="职业" {{#if isLocked}}disabled{{/if}}/>
            <input type="text" name="system.info.faction" value="{{system.info.faction}}" placeholder="势力" {{#if isLocked}}disabled{{/if}}/>
          </div>
        </div>

        <div class="character-info-right">
          <div class="level-display">
            <span class="level-label">Level</span>
            <span class="level-value">{{system.level}}</span>
          </div>
          <div class="exp-bar-container">
            <div class="exp-bar">
              <div class="exp-fill" style="width: {{multiply (divide system.info.experience 2700) 100}}%"></div>
              <span class="exp-text">{{system.info.experience}}/2700</span>
            </div>
          </div>
          <div class="action-buttons">
            <button class="action-btn long-rest-btn" type="button">长休</button>
            <button class="action-btn corruption-check-btn" type="button">侵蚀</button>
            <button class="action-btn combat-area-btn" type="button">战斗区域</button>
          </div>
        </div>
      </div>

      {{!-- 属性鉴定 --}}
      <div class="attributes-section">
        {{#each attributes as |attr key|}}
        <div class="attribute-box">
          <span class="attr-name">{{attr.label}}</span>
          <span class="attr-value">{{attr.value}}</span>
          <button class="attr-check-btn" data-attribute="{{key}}" type="button"></button>
        </div>
        {{/each}}
      </div>

      <div class="divider-line-full"></div>

      {{!-- 物品搜索 --}}
      <div class="item-search-bar">
        <div class="search-input-container">
          <input type="text" class="item-search-input" placeholder="搜索..." />
          <i class="fas fa-search"></i>
        </div>
        <button class="search-btn" data-action="favorite" type="button" title="收藏">
          <i class="fas fa-star"></i>
        </button>
        <button class="search-btn" data-action="filter" type="button" title="筛选">
          <i class="fas fa-filter"></i>
        </button>
        <button class="search-btn" data-action="sort" type="button" title="排序">
          <i class="fas fa-sort"></i>
        </button>
        <button class="search-btn" data-action="settings" type="button" title="设置">
          <i class="fas fa-cog"></i>
        </button>
        <button class="search-btn create-item-btn" type="button" title="创建物品">
          <i class="fas fa-plus"></i>
        </button>
      </div>

      <div class="divider-line-full"></div>

      {{!-- 物品栏 --}}
      <div class="inventory-section">
        <div class="inventory-header">
          <div class="inv-col icon-col">图标</div>
          <div class="inv-col name-col">名称</div>
          <div class="inv-col type-col">类型</div>
          <div class="inv-col category-col">分类</div>
          <div class="inv-col dice-col">骰数</div>
          <div class="inv-col cost-col">费用</div>
          <div class="inv-col quantity-col">数量</div>
          <div class="inv-col starlight-col">星光</div>
          <div class="inv-col actions-col">操作</div>
        </div>

        <div class="inventory-list">
          {{#each items as |item id|}}
          <div class="inventory-item" data-item-id="{{item._id}}">
            <div class="inv-col icon-col">
              <img src="{{item.img}}" class="item-icon" draggable="true"/>
            </div>
            <div class="inv-col name-col">{{item.name}}</div>
            <div class="inv-col type-col">{{item.typeLabel}}</div>
            <div class="inv-col category-col">{{item.system.category}}</div>
            <div class="inv-col dice-col">{{item.system.diceFormula}}</div>
            <div class="inv-col cost-col">{{item.system.cost}}</div>
            <div class="inv-col quantity-col">{{item.system.quantity}}</div>
            <div class="inv-col starlight-col">{{#if item.system.starlightCost}}{{item.system.starlightCost}}{{else}}-{{/if}}</div>
            <div class="inv-col actions-col">
              <button class="item-action-btn use-btn" data-item-id="{{item._id}}" type="button" title="使用">
                <i class="fas fa-play"></i>
              </button>
              <button class="item-action-btn edit-btn" data-item-id="{{item._id}}" type="button" title="编辑">
                <i class="fas fa-edit"></i>
              </button>
              <button class="item-action-btn delete-btn" data-item-id="{{item._id}}" type="button" title="删除">
                <i class="fas fa-trash"></i>
              </button>
              <button class="item-action-btn favorite-btn {{#if item.system.favorite}}favorited{{/if}}" data-item-id="{{item._id}}" type="button" title="收藏">
                <i class="fas fa-star"></i>
              </button>
            </div>
          </div>
          {{/each}}
        </div>
      </div>
    </div>
  </div>
</form>
