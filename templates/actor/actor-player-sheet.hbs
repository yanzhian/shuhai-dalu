<form class="{{cssClass}} player-sheet flexcol" autocomplete="off">

{{!-- Window Header: Tidy Switch 锁 --}}
<header class="window-header-custom">
  <button class="tidy-switch-btn {{#if isTidyLocked}}locked{{/if}}"
          title="{{#if isTidyLocked}}点击解锁编辑状态{{else}}点击锁定编辑状态{{/if}}"
          type="button">
    <i class="fas {{#if isTidyLocked}}fa-lock{{else}}fa-lock-open{{/if}}"></i>
    <span>{{#if isTidyLocked}}锁定{{else}}编辑{{/if}}</span>
  </button>
</header>

{{!-- 第一部分: Player Sheet Header --}}
  <div class="player-sheet-header">
    {{!-- 左侧：头像、状态条、按钮 --}}
    <div class="header-left">
      {{!-- 头像 --}}
      <div class="avatar-container">
        <img class="profile-img" src="{{actor.img}}" data-edit="img" title="{{actor.name}}"/>
      </div>

      {{!-- 生命值 --}}
      <div class="status-bar hp-bar">
        <div class="bar-fill hp" style="width: {{multiply (divide system.derived.hp.value system.derived.hp.max) 100}}%"></div>
        {{#unless isTidyLocked}}
        <input type="number" name="system.derived.hp.value" value="{{system.derived.hp.value}}" data-dtype="Number" min="0" max="{{system.derived.hp.max}}" class="bar-input left"/>
        <span class="bar-separator">/</span>
        <input type="number" name="system.derived.hp.max" value="{{system.derived.hp.max}}" data-dtype="Number" min="1" class="bar-input right"/>
        {{else}}
        <span class="bar-text">{{system.derived.hp.value}}/{{system.derived.hp.max}}</span>
        {{/unless}}
      </div>

      {{!-- 侵蚀值 --}}
      <div class="status-bar erosion-bar">
        <div class="bar-fill erosion" style="width: {{multiply (divide system.derived.corruption.value system.derived.corruption.max) 100}}%"></div>
        {{#unless isTidyLocked}}
        <input type="number" name="system.derived.corruption.value" value="{{system.derived.corruption.value}}" data-dtype="Number" min="0" max="{{system.derived.corruption.max}}" class="bar-input left"/>
        <span class="bar-separator">/</span>
        <input type="number" name="system.derived.corruption.max" value="{{system.derived.corruption.max}}" data-dtype="Number" min="1" class="bar-input right"/>
        {{else}}
        <span class="bar-text">{{system.derived.corruption.value}}/{{system.derived.corruption.max}}</span>
        {{/unless}}
      </div>

      {{!-- 混乱值 --}}
      <div class="status-bar chaos-bar">
        <div class="bar-fill chaos" style="width: {{multiply (divide system.derived.chaos 15) 100}}%"></div>
        {{#unless isTidyLocked}}
        <input type="number" name="system.derived.chaos" value="{{system.derived.chaos}}" data-dtype="Number" min="0" max="15" class="bar-input single"/>
        <span class="bar-text-fixed">/15</span>
        {{else}}
        <span class="bar-text">{{system.derived.chaos}}/15</span>
        {{/unless}}
      </div>

      {{!-- 四个按钮 --}}
      <div class="header-buttons">
        <button class="action-btn long-rest-btn" type="button">
          <i class="fas fa-bed"></i>
          <span>长休</span>
        </button>
        <button class="action-btn corruption-check-btn" type="button">
          <i class="fas fa-dice-d20"></i>
          <span>侵蚀鉴定</span>
        </button>
        <button class="action-btn inventory-btn" type="button">
          <i class="fas fa-backpack"></i>
          <span>物品栏</span>
        </button>
        <button class="action-btn combat-form-btn" type="button">
          <i class="fas fa-user-ninja"></i>
          <span>战斗形态</span>
        </button>
      </div>
    </div>

    {{!-- 右侧：名字、经验、等级、种族信息、属性鉴定 --}}
    <div class="header-right">
      {{!-- 名字和经验值 --}}
      <div class="name-exp-row">
        <div class="name-field">
          <input type="text" name="name" value="{{actor.name}}" placeholder="角色名称" {{#if isTidyLocked}}disabled{{/if}}/>
        </div>
        <div class="exp-display">
          {{#unless isTidyLocked}}
          <input type="number" name="system.info.experience" value="{{system.info.experience}}" data-dtype="Number" min="0" class="exp-input" title="当前经验"/>
          <span class="exp-sep">/</span>
          <span class="exp-max">{{expRequiredForNextLevel}}</span>
          <span class="exp-label">XP</span>
          {{else}}
          <span class="exp-text">{{system.info.experience}} / {{expRequiredForNextLevel}} XP</span>
          {{/unless}}
        </div>
      </div>

      {{!-- 经验条和等级 --}}
      <div class="exp-bar-row">
        <div class="xp-bar-current">
          <div class="xp-fill" style="width: {{expProgressPercent}}%"></div>
        </div>
        <div class="level-box">
          {{#unless isTidyLocked}}
          <label>等级</label>
          <input type="number" name="system.level" value="{{system.level}}" data-dtype="Number" min="1" max="12"/>
          {{else}}
          <span class="level-label">等级</span>
          <span class="level-value">{{system.level}}</span>
          {{/unless}}
        </div>
      </div>

      {{!-- 种族、性别、势力 --}}
      <div class="race-info-row">
        <div class="info-item">
          <label>种族</label>
          <input type="text" name="system.info.race" value="{{system.info.race}}" placeholder="种族" {{#if isTidyLocked}}disabled{{/if}}/>
        </div>
        <div class="info-item">
          <label>性别</label>
          <input type="text" name="system.info.gender" value="{{system.info.gender}}" placeholder="性别" {{#if isTidyLocked}}disabled{{/if}}/>
        </div>
        <div class="info-item">
          <label>势力</label>
          <input type="text" name="system.info.faction" value="{{system.info.faction}}" placeholder="所属势力" {{#if isTidyLocked}}disabled{{/if}}/>
        </div>
      </div>

      {{!-- 属性鉴定标题 --}}
      <div class="section-header">属性鉴定</div>

      {{!-- 属性鉴定 --}}
      <div class="attributes-row">
        {{#each attributes as |attr key|}}
        <div class="attr-block">
          <label>{{attr.label}}</label>
          {{#unless ../isTidyLocked}}
          <input type="number" name="system.attributes.{{key}}" value="{{attr.value}}" data-dtype="Number" min="1" max="30"/>
          {{else}}
          <span class="attr-value">{{attr.value}}</span>
          {{/unless}}
          <button class="attr-check-btn" data-attribute="{{key}}" type="button" title="{{attr.label}}检定">
            <i class="fas fa-dice-d20"></i>
          </button>
        </div>
        {{/each}}
      </div>
    </div>
  </div>

  {{!-- 第二部分: 技能鉴定区域 --}}
  <div class="skills-section">
    <div class="section-header">技能鉴定</div>
        <div class="skills-check-grid">
          {{!-- 力敏系技能鉴定 --}}
          <div class="skill-check-category">
            <span class="category-label">力敏系试探余 {{subtract system.skillPoints.strengthDex.total system.skillPoints.strengthDex.used}}</span>
            {{#each skillGroups.strengthDex as |skill key|}}
            <div class="skill-check-item">
              <button class="skill-action-btn minus" data-skill="{{key}}" data-category="strengthDex" type="button" {{#if ../../isLocked}}disabled{{/if}}>-</button>
              <span class="skill-name">{{skill.label}}</span>
              <span class="skill-value">{{skill.value}}</span>
              <button class="skill-action-btn plus" data-skill="{{key}}" data-category="strengthDex" type="button" {{#if ../../isLocked}}disabled{{/if}}>+</button>
              <button class="skill-check-btn" data-skill="{{key}}" type="button" title="{{skill.label}}检定">
                <i class="fas fa-circle"></i>
              </button>
            </div>
            {{/each}}
          </div>

          {{!-- 智力系技能鉴定 --}}
          <div class="skill-check-category">
            <span class="category-label">智力系试探余 {{subtract system.skillPoints.intelligence.total system.skillPoints.intelligence.used}}</span>
            {{#each skillGroups.intelligence as |skill key|}}
            <div class="skill-check-item">
              <button class="skill-action-btn minus" data-skill="{{key}}" data-category="intelligence" type="button" {{#if ../../isLocked}}disabled{{/if}}>-</button>
              <span class="skill-name">{{skill.label}}</span>
              <span class="skill-value">{{skill.value}}</span>
              <button class="skill-action-btn plus" data-skill="{{key}}" data-category="intelligence" type="button" {{#if ../../isLocked}}disabled{{/if}}>+</button>
              <button class="skill-check-btn" data-skill="{{key}}" type="button" title="{{skill.label}}检定">
                <i class="fas fa-circle"></i>
              </button>
            </div>
            {{/each}}
          </div>

          {{!-- 感知系技能鉴定 --}}
          <div class="skill-check-category">
            <span class="category-label">感知系试探余 {{subtract system.skillPoints.perception.total system.skillPoints.perception.used}}</span>
            {{#each skillGroups.perception as |skill key|}}
            <div class="skill-check-item">
              <button class="skill-action-btn minus" data-skill="{{key}}" data-category="perception" type="button" {{#if ../../isLocked}}disabled{{/if}}>-</button>
              <span class="skill-name">{{skill.label}}</span>
              <span class="skill-value">{{skill.value}}</span>
              <button class="skill-action-btn plus" data-skill="{{key}}" data-category="perception" type="button" {{#if ../../isLocked}}disabled{{/if}}>+</button>
              <button class="skill-check-btn" data-skill="{{key}}" type="button" title="{{skill.label}}检定">
                <i class="fas fa-circle"></i>
              </button>
            </div>
            {{/each}}
          </div>

          {{!-- 魅力系技能鉴定 --}}
          <div class="skill-check-category">
            <span class="category-label">魅力系试探余 {{subtract system.skillPoints.charisma.total system.skillPoints.charisma.used}}</span>
            {{#each skillGroups.charisma as |skill key|}}
            <div class="skill-check-item">
              <button class="skill-action-btn minus" data-skill="{{key}}" data-category="charisma" type="button" {{#if ../../isLocked}}disabled{{/if}}>-</button>
              <span class="skill-name">{{skill.label}}</span>
              <span class="skill-value">{{skill.value}}</span>
              <button class="skill-action-btn plus" data-skill="{{key}}" data-category="charisma" type="button" {{#if ../../isLocked}}disabled{{/if}}>+</button>
              <button class="skill-check-btn" data-skill="{{key}}" type="button" title="{{skill.label}}检定">
                <i class="fas fa-circle"></i>
              </button>
            </div>
            {{/each}}
          </div>
        </div>
      </div>
    </div>
  </div>

  {{!-- 第三部分: 装备栏 --}}
  <div class="equipment-section">
    <div class="section-header">装备栏</div>

    <div class="equipment-grid">
      {{!-- 星光剩余显示 --}}
      <div class="starlight-display">
        <div class="starlight-icon">
          <i class="fas fa-star"></i>
        </div>
        <div class="starlight-info">
          <span class="starlight-label">星光剩余</span>
          <span class="starlight-value">{{system.resources.starlight}}</span>
        </div>
      </div>

      {{!-- 武器槽位 --}}
      <div class="equip-slot square-slot" data-slot-type="weapon">
        <div class="slot-container" data-slot="weapon" data-item-id="{{system.equipment.weapon}}">
          {{#if (hasItem system.equipment.weapon)}}
            <img src="{{getItemImg system.equipment.weapon}}" class="slot-img" data-item-id="{{system.equipment.weapon}}" title="{{getItemEffect system.equipment.weapon}}"/>
            <div class="slot-cost-badge">{{getItemCost system.equipment.weapon}}</div>
            <button class="slot-unequip-btn" data-slot-type="weapon" type="button">×</button>
            <div class="slot-type-badge">武器</div>
            {{#if (getItemDice system.equipment.weapon)}}
            <div class="slot-dice-badge">{{getItemDice system.equipment.weapon}}</div>
            {{/if}}
          {{else}}
            <span class="slot-empty-text">武器</span>
          {{/if}}
        </div>
      </div>

      {{!-- 防具槽位 --}}
      <div class="equip-slot square-slot" data-slot-type="armor">
        <div class="slot-container" data-slot="armor" data-item-id="{{system.equipment.armor}}">
          {{#if (hasItem system.equipment.armor)}}
            <img src="{{getItemImg system.equipment.armor}}" class="slot-img" data-item-id="{{system.equipment.armor}}" title="{{getItemEffect system.equipment.armor}}"/>
            <div class="slot-cost-badge">{{getItemCost system.equipment.armor}}</div>
            <button class="slot-unequip-btn" data-slot-type="armor" type="button">×</button>
            <div class="slot-type-badge">防具</div>
            {{#if (getItemDice system.equipment.armor)}}
            <div class="slot-dice-badge">{{getItemDice system.equipment.armor}}</div>
            {{/if}}
          {{else}}
            <span class="slot-empty-text">防具</span>
          {{/if}}
        </div>
      </div>

      {{!-- 装备骰1-4 --}}
      {{#each system.equipment.equipmentDice as |diceId index|}}
      <div class="equip-slot square-slot" data-slot-type="equipmentDice" data-slot-index="{{index}}">
        <div class="slot-container" data-slot="equipmentDice" data-slot-index="{{index}}" data-item-id="{{diceId}}">
          {{#if (hasItem diceId)}}
            <img src="{{getItemImg diceId}}" class="slot-img" data-item-id="{{diceId}}" title="{{getItemEffect diceId}}"/>
            <div class="slot-cost-badge">{{getItemCost diceId}}</div>
            <button class="slot-unequip-btn" data-slot-type="equipmentDice" data-slot-index="{{index}}" type="button">×</button>
            <div class="slot-type-badge">装备</div>
            {{#if (getItemDice diceId)}}
            <div class="slot-dice-badge">{{getItemDice diceId}}</div>
            {{/if}}
          {{else}}
            <span class="slot-empty-text">装备{{add index 1}}</span>
          {{/if}}
        </div>
      </div>
      {{/each}}

      {{!-- 战斗骰1-6 --}}
      {{#each system.equipment.combatDice as |diceId index|}}
      <div class="equip-slot square-slot" data-slot-type="combatDice" data-slot-index="{{index}}">
        <div class="slot-container" data-slot="combatDice" data-slot-index="{{index}}" data-item-id="{{diceId}}">
          {{#if (hasItem diceId)}}
            <img src="{{getItemImg diceId}}" class="slot-img" data-item-id="{{diceId}}" title="{{getItemEffect diceId}}"/>
            <div class="slot-cost-badge">{{getItemCost diceId}}</div>
            <button class="slot-unequip-btn" data-slot-type="combatDice" data-slot-index="{{index}}" type="button">×</button>
            <div class="slot-type-badge">战斗</div>
            {{#if (getItemDice diceId)}}
            <div class="slot-dice-badge">{{getItemDice diceId}}</div>
            {{/if}}
          {{else}}
            <span class="slot-empty-text">战斗{{add index 1}}</span>
          {{/if}}
        </div>
      </div>
      {{/each}}

      {{!-- 守备骰 --}}
      <div class="equip-slot square-slot" data-slot-type="defenseDice">
        <div class="slot-container" data-slot="defenseDice" data-item-id="{{system.equipment.defenseDice}}">
          {{#if (hasItem system.equipment.defenseDice)}}
            <img src="{{getItemImg system.equipment.defenseDice}}" class="slot-img" data-item-id="{{system.equipment.defenseDice}}" title="{{getItemEffect system.equipment.defenseDice}}"/>
            <div class="slot-cost-badge">{{getItemCost system.equipment.defenseDice}}</div>
            <button class="slot-unequip-btn" data-slot-type="defenseDice" type="button">×</button>
            <div class="slot-type-badge">守备</div>
            {{#if (getItemDice system.equipment.defenseDice)}}
            <div class="slot-dice-badge">{{getItemDice system.equipment.defenseDice}}</div>
            {{/if}}
          {{else}}
            <span class="slot-empty-text">守备</span>
          {{/if}}
        </div>
      </div>

      {{!-- 触发骰 --}}
      <div class="equip-slot square-slot" data-slot-type="triggerDice">
        <div class="slot-container" data-slot="triggerDice" data-item-id="{{system.equipment.triggerDice}}">
          {{#if (hasItem system.equipment.triggerDice)}}
            <img src="{{getItemImg system.equipment.triggerDice}}" class="slot-img" data-item-id="{{system.equipment.triggerDice}}" title="{{getItemEffect system.equipment.triggerDice}}"/>
            <div class="slot-cost-badge">{{getItemCost system.equipment.triggerDice}}</div>
            <button class="slot-unequip-btn" data-slot-type="triggerDice" type="button">×</button>
            <div class="slot-type-badge">触发</div>
            {{#if (getItemDice system.equipment.triggerDice)}}
            <div class="slot-dice-badge">{{getItemDice system.equipment.triggerDice}}</div>
            {{/if}}
          {{else}}
            <span class="slot-empty-text">触发</span>
          {{/if}}
        </div>
      </div>
    </div>
  </div>

  {{!-- 第四部分: 底部资源显示 --}}
  <div class="resources-section">
    <div class="resource-item">
      <i class="fas fa-coins"></i>
      <label>货币</label>
      {{#unless isTidyLocked}}
      <input type="number" name="system.resources.currency" value="{{system.resources.currency}}" data-dtype="Number" min="0"/>
      {{else}}
      <span class="resource-value">{{system.resources.currency}}</span>
      {{/unless}}
    </div>
    <div class="resource-item">
      <i class="fas fa-map-marked-alt"></i>
      <label>奇遇点</label>
      {{#unless isTidyLocked}}
      <input type="number" name="system.resources.adventurePoints" value="{{system.resources.adventurePoints}}" data-dtype="Number" min="0"/>
      {{else}}
      <span class="resource-value">{{system.resources.adventurePoints}}</span>
      {{/unless}}
    </div>
    <div class="resource-item">
      <i class="fas fa-magic"></i>
      <label>奇迹点</label>
      {{#unless isTidyLocked}}
      <input type="number" name="system.resources.miraclePoints" value="{{system.resources.miraclePoints}}" data-dtype="Number" min="0"/>
      {{else}}
      <span class="resource-value">{{system.resources.miraclePoints}}</span>
      {{/unless}}
    </div>
    <div class="resource-item">
      <i class="fas fa-microchip"></i>
      <label>复制核心</label>
      {{#unless isTidyLocked}}
      <input type="number" name="system.resources.copyCore" value="{{system.resources.copyCore}}" data-dtype="Number" min="0"/>
      {{else}}
      <span class="resource-value">{{system.resources.copyCore}}</span>
      {{/unless}}
    </div>
  </div>

</form>
