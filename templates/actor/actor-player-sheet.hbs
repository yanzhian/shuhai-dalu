<form class="{{cssClass}} player-sheet flexcol" autocomplete="off">

  {{!-- 主容器：左右分栏 --}}
  <div class="sheet-container">

    {{!-- ========== 左侧栏 ========== --}}
    <div class="left-column">

      {{!-- 1. 头像区域 270x270 --}}
      <div class="avatar-container">
        <img class="profile-img" src="{{actor.img}}" data-edit="img" title="{{actor.name}}"/>
        <button class="lock-btn {{#if isLocked}}locked{{/if}}"
                title="{{#if isLocked}}点击解锁（编辑模式）{{else}}点击锁定（游玩模式）{{/if}}"
                type="button">
          <i class="fas {{#if isLocked}}fa-lock{{else}}fa-lock-open{{/if}}"></i>
        </button>
      </div>

      {{!-- 2. 生命值/侵蚀度/混乱值区域 高度96px --}}
      <div class="status-values-container">
        {{!-- 生命值 --}}
        <div class="status-bar hp-bar">
          <div class="bar-fill" style="width: {{multiply (divide system.derived.hp.value system.derived.hp.max) 100}}%"></div>
          <span class="bar-text">{{system.derived.hp.value}}/{{system.derived.hp.max}}</span>
        </div>

        {{!-- 侵蚀度和混乱值并排 --}}
        <div class="status-row">
          <div class="status-bar erosion-bar">
            <div class="bar-fill" style="width: {{multiply (divide system.derived.corruption.value system.derived.corruption.max) 100}}%"></div>
            <span class="bar-text">{{system.derived.corruption.value}}/{{system.derived.corruption.max}}</span>
          </div>
          <div class="status-bar chaos-bar">
            <div class="bar-fill" style="width: {{multiply (divide system.derived.chaos.value system.derived.chaos.max) 100}}%"></div>
            <span class="bar-text">{{system.derived.chaos.value}}/{{system.derived.chaos.max}}</span>
          </div>
        </div>

        {{!-- 编辑模式下的输入框 --}}
        {{#unless isLocked}}
        <div class="status-inputs">
          <input type="number" name="system.derived.hp.value" value="{{system.derived.hp.value}}" placeholder="HP"/>
          <input type="number" name="system.derived.corruption.value" value="{{system.derived.corruption.value}}" placeholder="侵蚀"/>
          <input type="number" name="system.derived.chaos.value" value="{{system.derived.chaos.value}}" placeholder="混乱"/>
        </div>
        {{/unless}}
      </div>

      {{!-- 3. 技能鉴定区域 --}}
      <div class="skills-section">
        <div class="section-header">
          <span class="line"></span>
          <span class="title">技能鉴定</span>
          <span class="line"></span>
        </div>
        <div class="skills-content scrollable">

        {{!-- 力敏系 --}}
        <div class="skill-category">
          <div class="category-header">
            <span>力敏剩余点数</span>
            <span class="remaining-points">{{subtract system.skillPoints.strengthDex.total system.skillPoints.strengthDex.used}}</span>
          </div>
          {{#each skillGroups.strengthDex as |skill key|}}
          <div class="skill-item">
            <button class="skill-action-btn minus" data-skill="{{key}}" data-category="strengthDex" type="button" {{#if ../../isLocked}}disabled{{/if}}>-</button>
            <span class="skill-name">{{skill.label}}</span>
            <span class="skill-value">{{skill.value}}</span>
            <button class="skill-action-btn plus" data-skill="{{key}}" data-category="strengthDex" type="button" {{#if ../../isLocked}}disabled{{/if}}>+</button>
            <button class="skill-check-btn" data-skill="{{key}}" type="button"></button>
          </div>
          {{/each}}
        </div>

        {{!-- 魅力系 --}}
        <div class="skill-category">
          <div class="category-header">
            <span>魅力剩余点数</span>
            <span class="remaining-points">{{subtract system.skillPoints.charisma.total system.skillPoints.charisma.used}}</span>
          </div>
          {{#each skillGroups.charisma as |skill key|}}
          <div class="skill-item">
            <button class="skill-action-btn minus" data-skill="{{key}}" data-category="charisma" type="button" {{#if ../../isLocked}}disabled{{/if}}>-</button>
            <span class="skill-name">{{skill.label}}</span>
            <span class="skill-value">{{skill.value}}</span>
            <button class="skill-action-btn plus" data-skill="{{key}}" data-category="charisma" type="button" {{#if ../../isLocked}}disabled{{/if}}>+</button>
            <button class="skill-check-btn" data-skill="{{key}}" type="button"></button>
          </div>
          {{/each}}
        </div>

        {{!-- 感知系 --}}
        <div class="skill-category">
          <div class="category-header">
            <span>感知剩余点数</span>
            <span class="remaining-points">{{subtract system.skillPoints.perception.total system.skillPoints.perception.used}}</span>
          </div>
          {{#each skillGroups.perception as |skill key|}}
          <div class="skill-item">
            <button class="skill-action-btn minus" data-skill="{{key}}" data-category="perception" type="button" {{#if ../../isLocked}}disabled{{/if}}>-</button>
            <span class="skill-name">{{skill.label}}</span>
            <span class="skill-value">{{skill.value}}</span>
            <button class="skill-action-btn plus" data-skill="{{key}}" data-category="perception" type="button" {{#if ../../isLocked}}disabled{{/if}}>+</button>
            <button class="skill-check-btn" data-skill="{{key}}" type="button"></button>
          </div>
          {{/each}}
        </div>

        {{!-- 智力系 --}}
        <div class="skill-category">
          <div class="category-header">
            <span>智力剩余点数</span>
            <span class="remaining-points">{{subtract system.skillPoints.intelligence.total system.skillPoints.intelligence.used}}</span>
          </div>
          {{#each skillGroups.intelligence as |skill key|}}
          <div class="skill-item">
            <button class="skill-action-btn minus" data-skill="{{key}}" data-category="intelligence" type="button" {{#if ../../isLocked}}disabled{{/if}}>-</button>
            <span class="skill-name">{{skill.label}}</span>
            <span class="skill-value">{{skill.value}}</span>
            <button class="skill-action-btn plus" data-skill="{{key}}" data-category="intelligence" type="button" {{#if ../../isLocked}}disabled{{/if}}>+</button>
            <button class="skill-check-btn" data-skill="{{key}}" type="button"></button>
          </div>
          {{/each}}
        </div>
        </div>
      </div>

      {{!-- 4. 装备栏 --}}
      <div class="equipment-section">
        <div class="section-header">
          <span class="line"></span>
          <span class="title">装备栏</span>
          <span class="line"></span>
        </div>
        <div class="equipment-content scrollable">

        {{!-- 武器和防具 --}}
        <div class="equipment-row-2">
          <div class="equipment-slot" data-slot-type="weapon">
            <div class="slot-content" data-slot="weapon" data-item-id="{{system.equipment.weapon}}" title="{{getItemTooltip system.equipment.weapon}}">
              {{#if (hasItem system.equipment.weapon)}}
                <img src="{{getItemImg system.equipment.weapon}}" class="item-icon" data-item-id="{{system.equipment.weapon}}"/>
                <div class="slot-cost">{{getItemCost system.equipment.weapon}}</div>
                <button class="unequip-btn" data-slot-type="weapon" type="button">×</button>
                {{#if (getItemDice system.equipment.weapon)}}
                <div class="slot-dice">{{getItemDice system.equipment.weapon}}</div>
                {{/if}}
              {{else}}
                <span class="empty-label">武器</span>
              {{/if}}
            </div>
          </div>

          <div class="equipment-slot" data-slot-type="armor">
            <div class="slot-content" data-slot="armor" data-item-id="{{system.equipment.armor}}" title="{{getItemTooltip system.equipment.armor}}">
              {{#if (hasItem system.equipment.armor)}}
                <img src="{{getItemImg system.equipment.armor}}" class="item-icon" data-item-id="{{system.equipment.armor}}"/>
                <div class="slot-cost">{{getItemCost system.equipment.armor}}</div>
                <button class="unequip-btn" data-slot-type="armor" type="button">×</button>
                {{#if (getItemDice system.equipment.armor)}}
                <div class="slot-dice">{{getItemDice system.equipment.armor}}</div>
                {{/if}}
              {{else}}
                <span class="empty-label">防具</span>
              {{/if}}
            </div>
          </div>
        </div>

        {{!-- 战斗骰 1-3 --}}
        <div class="equipment-row-3">
          {{#each system.equipment.combatDice as |diceId index|}}
          {{#if (lt index 3)}}
          <div class="equipment-slot" data-slot-type="combatDice" data-slot-index="{{index}}">
            <div class="slot-content" data-slot="combatDice" data-slot-index="{{index}}" data-item-id="{{diceId}}" title="{{getItemTooltip diceId}}">
              {{#if (hasItem diceId)}}
                <img src="{{getItemImg diceId}}" class="item-icon" data-item-id="{{diceId}}"/>
                <div class="slot-cost">{{getItemCost diceId}}</div>
                <button class="unequip-btn" data-slot-type="combatDice" data-slot-index="{{index}}" type="button">×</button>
                {{#if (getItemDice diceId)}}
                <div class="slot-dice">{{getItemDice diceId}}</div>
                {{/if}}
              {{else}}
                <span class="empty-label">战斗骰{{add index 1}}</span>
              {{/if}}
            </div>
          </div>
          {{/if}}
          {{/each}}
        </div>

        {{!-- 战斗骰 4-6 --}}
        <div class="equipment-row-3">
          {{#each system.equipment.combatDice as |diceId index|}}
          {{#if (gte index 3)}}
          <div class="equipment-slot" data-slot-type="combatDice" data-slot-index="{{index}}">
            <div class="slot-content" data-slot="combatDice" data-slot-index="{{index}}" data-item-id="{{diceId}}" title="{{getItemTooltip diceId}}">
              {{#if (hasItem diceId)}}
                <img src="{{getItemImg diceId}}" class="item-icon" data-item-id="{{diceId}}"/>
                <div class="slot-cost">{{getItemCost diceId}}</div>
                <button class="unequip-btn" data-slot-type="combatDice" data-slot-index="{{index}}" type="button">×</button>
                {{#if (getItemDice diceId)}}
                <div class="slot-dice">{{getItemDice diceId}}</div>
                {{/if}}
              {{else}}
                <span class="empty-label">战斗骰{{add index 1}}</span>
              {{/if}}
            </div>
          </div>
          {{/if}}
          {{/each}}
        </div>

        {{!-- 守备骰和触发骰 --}}
        <div class="equipment-row-2">
          <div class="equipment-slot" data-slot-type="defenseDice">
            <div class="slot-content" data-slot="defenseDice" data-item-id="{{system.equipment.defenseDice}}" title="{{getItemTooltip system.equipment.defenseDice}}">
              {{#if (hasItem system.equipment.defenseDice)}}
                <img src="{{getItemImg system.equipment.defenseDice}}" class="item-icon" data-item-id="{{system.equipment.defenseDice}}"/>
                <div class="slot-cost">{{getItemCost system.equipment.defenseDice}}</div>
                <button class="unequip-btn" data-slot-type="defenseDice" type="button">×</button>
                {{#if (getItemDice system.equipment.defenseDice)}}
                <div class="slot-dice">{{getItemDice system.equipment.defenseDice}}</div>
                {{/if}}
              {{else}}
                <span class="empty-label">守备骰</span>
              {{/if}}
            </div>
          </div>

          <div class="equipment-slot" data-slot-type="triggerDice">
            <div class="slot-content" data-slot="triggerDice" data-item-id="{{system.equipment.triggerDice}}" title="{{getItemTooltip system.equipment.triggerDice}}">
              {{#if (hasItem system.equipment.triggerDice)}}
                <img src="{{getItemImg system.equipment.triggerDice}}" class="item-icon" data-item-id="{{system.equipment.triggerDice}}"/>
                <div class="slot-cost">{{getItemCost system.equipment.triggerDice}}</div>
                <button class="unequip-btn" data-slot-type="triggerDice" type="button">×</button>
                {{#if (getItemDice system.equipment.triggerDice)}}
                <div class="slot-dice">{{getItemDice system.equipment.triggerDice}}</div>
                {{/if}}
              {{else}}
                <span class="empty-label">触发骰</span>
              {{/if}}
            </div>
          </div>
        </div>

        {{!-- 被动骰 1-3 --}}
        <div class="equipment-row-3">
          {{#each system.equipment.passives as |passiveId index|}}
          {{#if (lt index 3)}}
          <div class="equipment-slot" data-slot-type="passiveDice" data-slot-index="{{index}}">
            <div class="slot-content" data-slot="passiveDice" data-slot-index="{{index}}" data-item-id="{{passiveId}}" title="{{getItemTooltip passiveId}}">
              {{#if (hasItem passiveId)}}
                <img src="{{getItemImg passiveId}}" class="item-icon" data-item-id="{{passiveId}}"/>
                <div class="slot-cost">{{getItemCost passiveId}}</div>
                <button class="unequip-btn" data-slot-type="passiveDice" data-slot-index="{{index}}" type="button">×</button>
                {{#if (getItemDice passiveId)}}
                <div class="slot-dice">{{getItemDice passiveId}}</div>
                {{/if}}
              {{else}}
                <span class="empty-label">被动骰{{add index 1}}</span>
              {{/if}}
            </div>
          </div>
          {{/if}}
          {{/each}}
        </div>

        {{!-- 被动骰 4-6 --}}
        <div class="equipment-row-3">
          {{#each system.equipment.passives as |passiveId index|}}
          {{#if (gte index 3)}}
          <div class="equipment-slot" data-slot-type="passiveDice" data-slot-index="{{index}}">
            <div class="slot-content" data-slot="passiveDice" data-slot-index="{{index}}" data-item-id="{{passiveId}}" title="{{getItemTooltip passiveId}}">
              {{#if (hasItem passiveId)}}
                <img src="{{getItemImg passiveId}}" class="item-icon" data-item-id="{{passiveId}}"/>
                <div class="slot-cost">{{getItemCost passiveId}}</div>
                <button class="unequip-btn" data-slot-type="passiveDice" data-slot-index="{{index}}" type="button">×</button>
                {{#if (getItemDice passiveId)}}
                <div class="slot-dice">{{getItemDice passiveId}}</div>
                {{/if}}
              {{else}}
                <span class="empty-label">被动骰{{add index 1}}</span>
              {{/if}}
            </div>
          </div>
          {{/if}}
          {{/each}}
        </div>

        {{!-- 装备 1-2 --}}
        <div class="equipment-row-2">
          {{#each system.equipment.gear as |gearId index|}}
          {{#if (lt index 2)}}
          <div class="equipment-slot" data-slot-type="gear" data-slot-index="{{index}}">
            <div class="slot-content" data-slot="gear" data-slot-index="{{index}}" data-item-id="{{gearId}}" title="{{getItemTooltip gearId}}">
              {{#if (hasItem gearId)}}
                <img src="{{getItemImg gearId}}" class="item-icon" data-item-id="{{gearId}}"/>
                <div class="slot-cost">{{getItemCost gearId}}</div>
                <button class="unequip-btn" data-slot-type="gear" data-slot-index="{{index}}" type="button">×</button>
                {{#if (getItemDice gearId)}}
                <div class="slot-dice">{{getItemDice gearId}}</div>
                {{/if}}
              {{else}}
                <span class="empty-label">装备{{add index 1}}</span>
              {{/if}}
            </div>
          </div>
          {{/if}}
          {{/each}}
        </div>

        {{!-- 装备 3-4 --}}
        <div class="equipment-row-2">
          {{#each system.equipment.gear as |gearId index|}}
          {{#if (gte index 2)}}
          <div class="equipment-slot" data-slot-type="gear" data-slot-index="{{index}}">
            <div class="slot-content" data-slot="gear" data-slot-index="{{index}}" data-item-id="{{gearId}}" title="{{getItemTooltip gearId}}">
              {{#if (hasItem gearId)}}
                <img src="{{getItemImg gearId}}" class="item-icon" data-item-id="{{gearId}}"/>
                <div class="slot-cost">{{getItemCost gearId}}</div>
                <button class="unequip-btn" data-slot-type="gear" data-slot-index="{{index}}" type="button">×</button>
                {{#if (getItemDice gearId)}}
                <div class="slot-dice">{{getItemDice gearId}}</div>
                {{/if}}
              {{else}}
                <span class="empty-label">装备{{add index 1}}</span>
              {{/if}}
            </div>
          </div>
          {{/if}}
          {{/each}}
        </div>
        </div>
      </div>

      {{!-- 5. 资源区域 固定高度90px --}}
      <div class="resources-section">
        <div class="section-header">
          <span class="line"></span>
          <span class="title">资源</span>
          <span class="line"></span>
        </div>
        <div class="resources-grid">
          <div class="resource-item">
            <label>星光</label>
            <span>{{system.derived.starlight}}/{{add 10 (multiply system.level 2)}}</span>
          </div>
          <div class="resource-item">
            <label>货币</label>
            {{#if isLocked}}
            <span>{{system.resources.currency}}</span>
            {{else}}
            <input type="number" name="system.resources.currency" value="{{system.resources.currency}}" data-dtype="Number" min="0"/>
            {{/if}}
          </div>
          <div class="resource-item">
            <label>奇遇点</label>
            {{#if isLocked}}
            <span>{{system.resources.encounterPoints}}</span>
            {{else}}
            <input type="number" name="system.resources.encounterPoints" value="{{system.resources.encounterPoints}}" data-dtype="Number" min="0"/>
            {{/if}}
          </div>
          <div class="resource-item">
            <label>奇迹点</label>
            {{#if isLocked}}
            <span>{{system.resources.miraclePoints}}</span>
            {{else}}
            <input type="number" name="system.resources.miraclePoints" value="{{system.resources.miraclePoints}}" data-dtype="Number" min="0"/>
            {{/if}}
          </div>
          <div class="resource-item">
            <label>复制核心</label>
            {{#if isLocked}}
            <span>{{system.resources.replicaCore}}</span>
            {{else}}
            <input type="number" name="system.resources.replicaCore" value="{{system.resources.replicaCore}}" data-dtype="Number" min="0"/>
            {{/if}}
          </div>
        </div>
      </div>

    </div>{{!-- 左侧栏结束 --}}

    {{!-- ========== 右侧栏 ========== --}}
    <div class="right-column">

      {{!-- 6. 角色信息区域 --}}
      <div class="character-info">
        <div class="info-left-part">
          <input type="text" name="name" class="character-name" value="{{actor.name}}" placeholder="玩家角色名字" {{#if isLocked}}disabled{{/if}}/>
          <div class="character-details">
            <input type="text" name="system.info.race" value="{{system.info.race}}" placeholder="种族" {{#if isLocked}}disabled{{/if}}/>
            <input type="text" name="system.info.gender" value="{{system.info.gender}}" placeholder="性别" {{#if isLocked}}disabled{{/if}}/>
            <input type="text" name="system.info.class" value="{{system.info.class}}" placeholder="职业" {{#if isLocked}}disabled{{/if}}/>
            <input type="text" name="system.info.faction" value="{{system.info.faction}}" placeholder="势力" {{#if isLocked}}disabled{{/if}}/>
          </div>
        </div>

        <div class="info-right-part">
          <div class="level-display">
            <span class="level-label">LEVEL</span>
            {{#if isLocked}}
            <span class="level-value">{{system.level}}</span>
            {{else}}
            <input type="number" name="system.level" class="level-value" value="{{system.level}}" data-dtype="Number" min="1"/>
            {{/if}}
          </div>
          <div class="exp-bar-container">
            <div class="exp-bar">
              <div class="exp-fill" style="width: {{multiply (divide system.info.experience maxExp) 100}}%"></div>
            </div>
            <span class="exp-text">{{system.info.experience}}/{{maxExp}}</span>
            {{#unless isLocked}}
            <input type="number" name="system.info.experience" value="{{system.info.experience}}" data-dtype="Number" min="0" max="{{maxExp}}" style="width: 80px; text-align: center; margin-top: 4px;"/>
            {{/unless}}
          </div>
          <div class="action-buttons">
            <button class="action-btn long-rest-btn" type="button">长休</button>
            <button class="action-btn corruption-check-btn" type="button">侵蚀</button>
            <button class="action-btn switch-combat-btn" type="button">战斗区域</button>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      {{!-- 7. 属性鉴定区域 --}}
      <div class="attributes-section">
        {{#each attributes as |attr key|}}
        <div class="attribute-box">
          <span class="attr-name">{{attr.label}}</span>
          {{#if ../isLocked}}
          <span class="attr-value">{{attr.value}}</span>
          {{else}}
          <input type="number" name="system.attributes.{{key}}" class="attr-value" value="{{attr.value}}" data-dtype="Number" min="1" max="30"/>
          {{/if}}
          <button class="attr-check-btn" data-attribute="{{key}}" type="button"></button>
        </div>
        {{/each}}
      </div>

      <div class="divider"></div>

      {{!-- 8. 物品搜索栏 --}}
      <div class="item-search-bar">
        <div class="search-input-wrapper">
          <input type="text" class="item-search" placeholder="搜索..." />
          <i class="fas fa-search"></i>
        </div>
        <button class="search-btn favorite-filter-btn" data-filter="favorite" type="button">
          <i class="fas fa-star"></i>
        </button>
        <button class="search-btn advanced-filter-btn" type="button">
          <i class="fas fa-filter"></i>
        </button>
        <button class="search-btn sort-btn" type="button">
          <i class="fas fa-sort"></i>
        </button>
        <button class="search-btn settings-btn" type="button">
          <i class="fas fa-cog"></i>
        </button>
        <button class="search-btn create-item-btn" type="button">
          <i class="fas fa-plus-circle"></i>
        </button>
      </div>

      <div class="divider"></div>

      {{!-- 9. 物品栏 --}}
      <div class="inventory-section">
        <div class="inventory-header">
          <div class="col-icon">图标</div>
          <div class="col-name">名称</div>
          <div class="col-type">类型</div>
          <div class="col-category">分类</div>
          <div class="col-dice">骰数</div>
          <div class="col-cost">费用</div>
          <div class="col-quantity">数量</div>
          <div class="col-starlight">星光</div>
          <div class="col-actions">操作</div>
        </div>

        <div class="inventory-list scrollable">
          {{#each items as |item id|}}
          <div class="inventory-row {{#if item.isEquipped}}equipped{{/if}}"
               data-item-id="{{item._id}}"
               data-item-type="{{item.type}}"
               data-filtered="false">
            <div class="col-icon">
              <div class="item-icon-wrapper" data-item-id="{{item._id}}" title="{{item.system.effect}}" draggable="true">
                <img src="{{item.img}}" class="item-icon" data-item-id="{{item._id}}"/>
              </div>
            </div>
            <div class="col-name">{{item.name}}</div>
            <div class="col-type">{{item.typeLabel}}</div>
            <div class="col-category">{{item.system.category}}</div>
            <div class="col-dice">{{item.system.diceFormula}}</div>
            <div class="col-cost">{{item.system.cost}}</div>
            <div class="col-quantity">{{item.system.quantity}}</div>
            <div class="col-starlight">{{#if item.system.starlightCost}}{{item.system.starlightCost}}{{else}}-{{/if}}</div>
            <div class="col-actions">
              <button class="item-action-btn item-use-btn" data-item-id="{{item._id}}" type="button"><i class="fas fa-play-circle"></i></button>
              <button class="item-action-btn item-edit-btn" data-item-id="{{item._id}}" type="button"><i class="fas fa-edit"></i></button>
              <button class="item-action-btn item-delete-btn" data-item-id="{{item._id}}" type="button"><i class="fas fa-trash-alt"></i></button>
              <button class="item-action-btn item-favorite-btn {{#if item.isEquipped}}equipped{{/if}}" data-item-id="{{item._id}}" type="button"><i class="fas fa-check-circle"></i></button>
            </div>
          </div>
          {{/each}}
        </div>
      </div>

    </div>{{!-- 右侧栏结束 --}}

  </div>{{!-- 主容器结束 --}}

</form>
