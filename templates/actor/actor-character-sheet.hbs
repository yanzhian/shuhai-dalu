<form class="{{cssClass}} flexcol" autocomplete="off">
  {{!-- Sheet Header --}}
  <header class="sheet-header">
    <img class="profile-img" src="{{actor.img}}" data-edit="img" title="{{actor.name}}" height="120" width="120"/>
    <div class="header-fields">
      <h1 class="charname">
        <input name="name" type="text" value="{{actor.name}}" placeholder="è§’è‰²åç§°"/>
      </h1>
      
      {{!-- åŸºç¡€ä¿¡æ¯è¡Œ --}}
      <div class="info-row">
        <div class="info-field">
          <label>ç­‰çº§</label>
          <input type="number" name="system.level" value="{{system.level}}" data-dtype="Number" min="1"/>
        </div>
        <div class="info-field">
          <label>ç»éªŒ</label>
          <input type="number" name="system.info.experience" value="{{system.info.experience}}" data-dtype="Number" min="0"/>
        </div>
        <div class="info-field">
          <label>æ€§åˆ«</label>
          <input type="text" name="system.info.gender" value="{{system.info.gender}}" placeholder="æ€§åˆ«"/>
        </div>
        <div class="info-field">
          <label>ç§æ—</label>
          <input type="text" name="system.info.race" value="{{system.info.race}}" placeholder="äººç±»"/>
        </div>
        <div class="info-field">
          <label>åŠ¿åŠ›</label>
          <input type="text" name="system.info.faction" value="{{system.info.faction}}" placeholder=""/>
        </div>
      </div>
      
      {{!-- æ´¾ç”Ÿå±æ€§è¡Œ --}}
      <div class="derived-row">
        <div class="resource-box starlight">
          <label>â­ æ˜Ÿå…‰</label>
          <div class="resource-value">
            <span class="current">{{system.derived.starlight}}</span>
            <span class="sep">/</span>
            <span class="max">{{add 10 (multiply system.level 2)}}</span>
          </div>
          <div class="resource-detail">å·²ç”¨: {{system.derived.starlightUsed}}</div>
        </div>
        
        <div class="resource-box hp">
          <label>â¤ï¸ ç”Ÿå‘½å€¼</label>
          <div class="resource-bar">
            <input type="number" name="system.derived.hp.value" value="{{system.derived.hp.value}}" data-dtype="Number" min="0"/>
            <span class="sep">/</span>
            <span class="max">{{system.derived.hp.max}}</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" style="width: {{multiply (divide system.derived.hp.value system.derived.hp.max) 100}}%"></div>
          </div>
        </div>
        
        <div class="resource-box corruption">
          <label>ğŸ’€ ä¾µèš€åº¦</label>
          <div class="resource-bar">
            <input type="number" name="system.derived.corruption.value" value="{{system.derived.corruption.value}}" data-dtype="Number" min="0"/>
            <span class="sep">/</span>
            <span class="max">{{system.derived.corruption.max}}</span>
          </div>
          <div class="progress-bar corruption">
            <div class="progress-fill" style="width: {{multiply (divide system.derived.corruption.value system.derived.corruption.max) 100}}%"></div>
          </div>
        </div>
        
        <div class="resource-box chaos">
          <label>âš¡ æ··ä¹±æ¡</label>
          <div class="resource-value">{{system.derived.chaos}}</div>
        </div>
        
        <div class="resource-box speed">
          <label>ğŸƒ é€Ÿåº¦å€¼</label>
          <div class="resource-value">{{system.derived.speed}}</div>
        </div>
      </div>
      
      {{!-- è´§å¸å’Œèµ„æºè¡Œ --}}
      <div class="currency-row">
        <div class="currency-field">
          <label>ğŸ’° è´§å¸</label>
          <input type="number" name="system.resources.currency" value="{{system.resources.currency}}" data-dtype="Number" min="0"/>
        </div>
        <div class="currency-field">
          <label>ğŸ² å¥‡é‡ç‚¹</label>
          <input type="number" name="system.resources.encounterPoints" value="{{system.resources.encounterPoints}}" data-dtype="Number" min="0"/>
        </div>
        <div class="currency-field">
          <label>âœ¨ å¥‡è¿¹ç‚¹</label>
          <input type="number" name="system.resources.miraclePoints" value="{{system.resources.miraclePoints}}" data-dtype="Number" min="0"/>
        </div>
        <div class="currency-field">
          <label>ğŸ”® å¤åˆ¶æ ¸å¿ƒ</label>
          <input type="number" name="system.resources.replicaCore" value="{{system.resources.replicaCore}}" data-dtype="Number" min="0"/>
        </div>
      </div>
    </div>
  </header>

  {{!-- Sheet Tab Navigation --}}
  <nav class="sheet-tabs tabs" data-group="primary">
    <a class="item" data-tab="attributes">1.å±æ€§</a>
    <a class="item" data-tab="skills">2.æŠ€èƒ½</a>
    <a class="item" data-tab="equipment">3.è£…å¤‡</a>
    <a class="item" data-tab="inventory">4.ç‰©å“æ </a>
    <a class="item" data-tab="biography">èƒŒæ™¯</a>
  </nav>

  {{!-- Sheet Body --}}
  <section class="sheet-body">
    
    {{!-- ==================== 1. å±æ€§æ ‡ç­¾é¡µ ==================== --}}
    <div class="tab attributes" data-group="primary" data-tab="attributes">
      <div class="attributes-section">
        <h3>åŸºç¡€å±æ€§</h3>
        <div class="attributes-grid">
          {{#each attributes as |attr key|}}
          <div class="attribute-box" data-attribute="{{key}}">
            <div class="attr-label">{{attr.label}}</div>
            <input type="number" class="attr-value" name="system.attributes.{{key}}" value="{{attr.value}}" data-dtype="Number" min="1" max="30"/>
            <button class="attr-roll" data-attribute="{{key}}" title="{{attr.label}}æ£€å®š">
              <i class="fas fa-dice-d20"></i> æ£€å®š
            </button>
          </div>
          {{/each}}
        </div>
      </div>
      
      <div class="actions-section">
        <button class="corruption-check action-btn">
          <i class="fas fa-skull"></i> ä¾µèš€æ£€å®š
        </button>
        <button class="long-rest action-btn">
          <i class="fas fa-bed"></i> é•¿æœŸä¼‘æ¯
        </button>
        <button class="roll-speed action-btn">
          <i class="fas fa-running"></i> æŠ•æ·é€Ÿåº¦
        </button>
      </div>
    </div>

    {{!-- ==================== 2. æŠ€èƒ½æ ‡ç­¾é¡µ ==================== --}}
    <div class="tab skills" data-group="primary" data-tab="skills">
      {{!-- åŠ›æ•æŠ€èƒ½ --}}
      <div class="skill-category">
        <div class="category-header">
          <h3>åŠ›æ•æŠ€èƒ½</h3>
          <div class="skill-points">
            <span class="points-used">{{system.skillPoints.strengthDex.used}}</span>
            <span class="sep">/</span>
            <span class="points-total">{{system.skillPoints.strengthDex.total}}</span>
            <span class="points-label">ç‚¹</span>
          </div>
        </div>
        <div class="skills-grid">
          {{#each skillGroups.strengthDex as |skill key|}}
          <div class="skill-item">
            <label>{{skill.label}}</label>
            <div class="skill-controls">
              <button class="skill-decrease" data-skill="{{key}}" data-category="strengthDex" title="å‡å°‘">-</button>
              <input type="number" name="system.skills.{{key}}" value="{{skill.value}}" data-dtype="Number" min="0" max="25" readonly/>
              <button class="skill-increase" data-skill="{{key}}" data-category="strengthDex" title="å¢åŠ ">+</button>
              <button class="skill-roll" data-skill="{{key}}" title="{{skill.label}}æ£€å®š">
                <i class="fas fa-dice-d20"></i>
              </button>
            </div>
          </div>
          {{/each}}
        </div>
      </div>
      
      {{!-- æ™ºåŠ›æŠ€èƒ½ --}}
      <div class="skill-category">
        <div class="category-header">
          <h3>æ™ºåŠ›æŠ€èƒ½</h3>
          <div class="skill-points">
            <span class="points-used">{{system.skillPoints.intelligence.used}}</span>
            <span class="sep">/</span>
            <span class="points-total">{{system.skillPoints.intelligence.total}}</span>
            <span class="points-label">ç‚¹</span>
          </div>
        </div>
        <div class="skills-grid">
          {{#each skillGroups.intelligence as |skill key|}}
          <div class="skill-item">
            <label>{{skill.label}}</label>
            <div class="skill-controls">
              <button class="skill-decrease" data-skill="{{key}}" data-category="intelligence" title="å‡å°‘">-</button>
              <input type="number" name="system.skills.{{key}}" value="{{skill.value}}" data-dtype="Number" min="0" max="25" readonly/>
              <button class="skill-increase" data-skill="{{key}}" data-category="intelligence" title="å¢åŠ ">+</button>
              <button class="skill-roll" data-skill="{{key}}" title="{{skill.label}}æ£€å®š">
                <i class="fas fa-dice-d20"></i>
              </button>
            </div>
          </div>
          {{/each}}
        </div>
      </div>
      
      {{!-- æ„ŸçŸ¥æŠ€èƒ½ --}}
      <div class="skill-category">
        <div class="category-header">
          <h3>æ„ŸçŸ¥æŠ€èƒ½</h3>
          <div class="skill-points">
            <span class="points-used">{{system.skillPoints.perception.used}}</span>
            <span class="sep">/</span>
            <span class="points-total">{{system.skillPoints.perception.total}}</span>
            <span class="points-label">ç‚¹</span>
          </div>
        </div>
        <div class="skills-grid">
          {{#each skillGroups.perception as |skill key|}}
          <div class="skill-item">
            <label>{{skill.label}}</label>
            <div class="skill-controls">
              <button class="skill-decrease" data-skill="{{key}}" data-category="perception" title="å‡å°‘">-</button>
              <input type="number" name="system.skills.{{key}}" value="{{skill.value}}" data-dtype="Number" min="0" max="25" readonly/>
              <button class="skill-increase" data-skill="{{key}}" data-category="perception" title="å¢åŠ ">+</button>
              <button class="skill-roll" data-skill="{{key}}" title="{{skill.label}}æ£€å®š">
                <i class="fas fa-dice-d20"></i>
              </button>
            </div>
          </div>
          {{/each}}
        </div>
      </div>
      
      {{!-- é­…åŠ›æŠ€èƒ½ --}}
      <div class="skill-category">
        <div class="category-header">
          <h3>é­…åŠ›æŠ€èƒ½</h3>
          <div class="skill-points">
            <span class="points-used">{{system.skillPoints.charisma.used}}</span>
            <span class="sep">/</span>
            <span class="points-total">{{system.skillPoints.charisma.total}}</span>
            <span class="points-label">ç‚¹</span>
          </div>
        </div>
        <div class="skills-grid">
          {{#each skillGroups.charisma as |skill key|}}
          <div class="skill-item">
            <label>{{skill.label}}</label>
            <div class="skill-controls">
              <button class="skill-decrease" data-skill="{{key}}" data-category="charisma" title="å‡å°‘">-</button>
              <input type="number" name="system.skills.{{key}}" value="{{skill.value}}" data-dtype="Number" min="0" max="25" readonly/>
              <button class="skill-increase" data-skill="{{key}}" data-category="charisma" title="å¢åŠ ">+</button>
              <button class="skill-roll" data-skill="{{key}}" title="{{skill.label}}æ£€å®š">
                <i class="fas fa-dice-d20"></i>
              </button>
            </div>
          </div>
          {{/each}}
        </div>
      </div>
    </div>

    {{!-- ==================== 3. è£…å¤‡æ ‡ç­¾é¡µ ==================== --}}
    <div class="tab equipment" data-group="primary" data-tab="equipment">
      <div class="equipment-section">
        <h3>è£…å¤‡æ§½</h3>
        <div class="equipment-slots">
          <div class="equipment-slot" data-slot-type="weapon">
            <label>ğŸ—¡ï¸ æ­¦å™¨</label>
            <div class="slot-content" data-slot="weapon" data-item-id="{{system.equipment.weapon}}">
              {{#if (hasItem system.equipment.weapon)}}
                <span class="item-name">{{getItemName system.equipment.weapon}}</span>
                <button class="unequip-btn" data-slot-type="weapon"><i class="fas fa-times"></i></button>
              {{else}}
                <span class="empty-slot">ç©º</span>
              {{/if}}
            </div>
          </div>
          
          <div class="equipment-slot" data-slot-type="armor">
            <label>ğŸ›¡ï¸ é˜²å…·</label>
            <div class="slot-content" data-slot="armor" data-item-id="{{system.equipment.armor}}">
              {{#if (hasItem system.equipment.armor)}}
                <span class="item-name">{{getItemName system.equipment.armor}}</span>
                <button class="unequip-btn" data-slot-type="armor"><i class="fas fa-times"></i></button>
              {{else}}
                <span class="empty-slot">ç©º</span>
              {{/if}}
            </div>
          </div>
          
          {{#each system.equipment.items as |itemId index|}}
          <div class="equipment-slot" data-slot-type="item">
            <label>ğŸ“¦ ç‰©å“{{add index 1}}</label>
            <div class="slot-content" data-slot="item" data-slot-index="{{index}}" data-item-id="{{itemId}}">
              {{#if (hasItem itemId)}}
                <span class="item-name">{{getItemName itemId}}</span>
                <button class="unequip-btn" data-slot-type="item" data-slot-index="{{index}}"><i class="fas fa-times"></i></button>
              {{else}}
                <span class="empty-slot">ç©º</span>
              {{/if}}
            </div>
          </div>
          {{/each}}
          
          {{#each system.equipment.gear as |gearId index|}}
          <div class="equipment-slot" data-slot-type="gear">
            <label>âš™ï¸ è£…å¤‡{{add index 1}}</label>
            <div class="slot-content" data-slot="gear" data-slot-index="{{index}}" data-item-id="{{gearId}}">
              {{#if (hasItem gearId)}}
                <span class="item-name">{{getItemName gearId}}</span>
                <button class="unequip-btn" data-slot-type="gear" data-slot-index="{{index}}"><i class="fas fa-times"></i></button>
              {{else}}
                <span class="empty-slot">ç©º</span>
              {{/if}}
            </div>
          </div>
          {{/each}}
        </div>
      </div>
      
      <div class="combat-dice-section">
        <h3>æˆ˜æ–—éª°</h3>
        <div class="dice-slots">
          {{#each system.equipment.combatDice as |diceId index|}}
          <div class="dice-slot" data-slot-type="combatDice">
            <label>D{{add index 1}}</label>
            <div class="slot-content" data-slot="combatDice" data-slot-index="{{index}}" data-item-id="{{diceId}}">
              {{#if (hasItem diceId)}}
                <span class="item-name">{{getItemName diceId}}</span>
                <button class="use-dice-btn" data-item-id="{{diceId}}"><i class="fas fa-play"></i></button>
                <button class="unequip-btn" data-slot-type="combatDice" data-slot-index="{{index}}"><i class="fas fa-times"></i></button>
              {{else}}
                <span class="empty-slot">ç©º</span>
              {{/if}}
            </div>
          </div>
          {{/each}}
        </div>
      </div>
      
      <div class="special-dice-section">
        <h3>ç‰¹æ®Šéª°</h3>
        <div class="special-slots">
          <div class="dice-slot" data-slot-type="defenseDice">
            <label>ğŸ›¡ï¸ å®ˆå¤‡éª°</label>
            <div class="slot-content" data-slot="defenseDice" data-item-id="{{system.equipment.defenseDice}}">
              {{#if (hasItem system.equipment.defenseDice)}}
                <span class="item-name">{{getItemName system.equipment.defenseDice}}</span>
                <button class="use-dice-btn" data-item-id="{{system.equipment.defenseDice}}"><i class="fas fa-play"></i></button>
                <button class="unequip-btn" data-slot-type="defenseDice"><i class="fas fa-times"></i></button>
              {{else}}
                <span class="empty-slot">ç©º</span>
              {{/if}}
            </div>
          </div>
          
          <div class="dice-slot" data-slot-type="triggerDice">
            <label>âš¡ è§¦å‘éª°</label>
            <div class="slot-content" data-slot="triggerDice" data-item-id="{{system.equipment.triggerDice}}">
              {{#if (hasItem system.equipment.triggerDice)}}
                <span class="item-name">{{getItemName system.equipment.triggerDice}}</span>
                <button class="use-dice-btn" data-item-id="{{system.equipment.triggerDice}}"><i class="fas fa-play"></i></button>
                <button class="unequip-btn" data-slot-type="triggerDice"><i class="fas fa-times"></i></button>
              {{else}}
                <span class="empty-slot">ç©º</span>
              {{/if}}
            </div>
          </div>
        </div>
      </div>
      
      <div class="passive-section">
        <h3>è¢«åŠ¨æŠ€èƒ½</h3>
        <div class="passive-slots">
          {{#each system.equipment.passives as |passiveId index|}}
          <div class="passive-slot" data-slot-type="passive">
            <label>è¢«åŠ¨{{add index 1}}</label>
            <div class="slot-content" data-slot="passive" data-slot-index="{{index}}" data-item-id="{{passiveId}}">
              {{#if (hasItem passiveId)}}
                <span class="item-name">{{getItemName passiveId}}</span>
                <button class="unequip-btn" data-slot-type="passive" data-slot-index="{{index}}"><i class="fas fa-times"></i></button>
              {{else}}
                <span class="empty-slot">ç©º</span>
              {{/if}}
            </div>
          </div>
          {{/each}}
        </div>
      </div>
    </div>

    {{!-- ==================== 4. ç‰©å“æ æ ‡ç­¾é¡µ ==================== --}}
    <div class="tab inventory" data-group="primary" data-tab="inventory">
      <div class="inventory-controls">
        <button class="create-item-btn" data-type="combatDice"><i class="fas fa-plus"></i> æ”»å‡»éª°</button>
        <button class="create-item-btn" data-type="shootDice"><i class="fas fa-plus"></i> å°„å‡»éª°</button>
        <button class="create-item-btn" data-type="defenseDice"><i class="fas fa-plus"></i> å®ˆå¤‡éª°</button>
        <button class="create-item-btn" data-type="triggerDice"><i class="fas fa-plus"></i> è§¦å‘éª°</button>
        <button class="create-item-btn" data-type="passiveDice"><i class="fas fa-plus"></i> è¢«åŠ¨éª°</button>
        <button class="create-item-btn" data-type="weapon"><i class="fas fa-plus"></i> æ­¦å™¨</button>
        <button class="create-item-btn" data-type="armor"><i class="fas fa-plus"></i> é˜²å…·</button>
        <button class="create-item-btn" data-type="item"><i class="fas fa-plus"></i> ç‰©å“</button>
        <button class="create-item-btn" data-type="equipment"><i class="fas fa-plus"></i> è£…å¤‡</button>
      </div>
      
      <div class="inventory-list">
        <table class="items-table">
          <thead>
            <tr>
              <th>åç§°</th>
              <th>ç±»å‹</th>
              <th>åˆ†ç±»</th>
              <th>éª°æ•°</th>
              <th>è´¹ç”¨</th>
              <th>æ•°é‡</th>
              <th>æ˜Ÿå…‰</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            {{#each items as |item id|}}
            <tr class="item-row" data-item-id="{{item._id}}" draggable="true">
              <td class="item-name">
                <img src="{{item.img}}" width="24" height="24"/>
                <span>{{item.name}}</span>
              </td>
              <td>{{item.type}}</td>
              <td>{{item.system.category}}</td>
              <td>{{item.system.diceFormula}}</td>
              <td>{{item.system.cost}}</td>
              <td>{{item.system.quantity}}</td>
              <td>{{item.system.starlightCost}}</td>
              <td class="item-controls">
                <button class="item-use" data-item-id="{{item._id}}" title="ä½¿ç”¨"><i class="fas fa-play"></i></button>
                <button class="item-edit" data-item-id="{{item._id}}" title="ç¼–è¾‘"><i class="fas fa-edit"></i></button>
                <button class="item-delete" data-item-id="{{item._id}}" title="åˆ é™¤"><i class="fas fa-trash"></i></button>
              </td>
            </tr>
            {{/each}}
          </tbody>
        </table>
      </div>
    </div>

    {{!-- Biography Tab --}}
    <div class="tab biography" data-group="primary" data-tab="biography">
      {{editor enrichedBiography target="system.biography" button=true owner=owner editable=editable}}
    </div>
  </section>
</form>