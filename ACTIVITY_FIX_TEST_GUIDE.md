# Activity 系统修复 - 测试指南

## 修复概述

本次修复解决了 Activity Editor V2 和触发器系统的多个问题：

### 已修复的问题

1. ✅ **Handlebars partial 注册失败** - 将所有 partial 内联到主模板
2. ✅ **`{{inc}}` helper 不存在** - 改用 `{{add @index 1}}`
3. ✅ **BUFF 名称本地化显示问题** - 修复聊天消息中显示 "SHUHAI.Buff.charge"
4. ✅ **条件编辑器缺失目标字段** - 添加"检查目标"选择器（自己/对手）
5. ✅ **触发器系统未使用新 ActivityExecutor** - combat-area.mjs 现在使用新系统
6. ✅ **onDamaged 触发器缺失** - 在 Actor.takeDamage() 中添加
7. ✅ **onFlashStrike/onDiscard 导入路径错误** - 修复为使用 activity-service.mjs

---

## 测试步骤

### 1. 测试编辑器基本功能

**目标**：确认编辑器能正常打开和编辑

#### 步骤：
1. 打开任意 Item 卡片
2. 点击"添加 Activity"按钮
3. **预期结果**：
   - ✅ 编辑器窗口正常打开
   - ✅ 显示 5 个颜色区块（蓝色触发、黄色条件、红色消耗、绿色效果、紫色限制）
   - ✅ 所有表单字段正常显示

#### 测试要点：
- 编辑器不应出现红色报错
- 所有下拉菜单和输入框可见

---

### 2. 测试条件编辑器

**目标**：确认条件编辑器有"目标"字段

#### 步骤：
1. 在 Activity 编辑器中，点击"前置条件"的 **+** 按钮
2. **预期结果**：
   - ✅ 新增一个条件项，显示"条件 1"
   - ✅ 有"条件类型"下拉菜单
   - ✅ 有"检查目标"下拉菜单（自己/对手）
   - ✅ 根据条件类型显示相应字段（BUFF ID、比较符、数值等）

#### 测试案例：
创建条件："对手拥有充能 BUFF 且层数 >= 3"
```
条件类型: BUFF层数
检查目标: 对手
BUFF ID: charge
比较: >=
值: 3
```

---

### 3. 测试效果编辑器

**目标**：确认效果编辑器正常工作

#### 步骤：
1. 在 Activity 编辑器中，点击"效果"的 **+** 按钮
2. **预期结果**：
   - ✅ 新增一个效果项，显示"效果 1"
   - ✅ 有"效果类型"下拉菜单
   - ✅ 根据效果类型显示相应字段

#### 测试案例：
创建效果："为自己添加 2 层强壮 BUFF（本回合）"
```
效果类型: 添加BUFF
BUFF ID: strong
层数: 2
强度: 0
目标: 自己
回合时机: 本回合
```

点击"保存"，应该能成功保存。

---

### 4. 测试 onUse 触发器（使用时）

**目标**：确认"使用时"触发器正常工作

#### 步骤：
1. 创建一个 combatDice 物品
2. 添加 Activity：
   ```
   触发时机: 使用时 (onUse)
   效果: 为自己添加 3 层充能
   ```
3. 保存并装备此骰子
4. 在战斗中点击"攻击"按钮使用这个骰子
5. **预期结果**：
   - ✅ 聊天窗口显示 Activity 执行消息
   - ✅ 消息中显示"为自己添加 3 层【充能】"（中文，不是 SHUHAI.Buff.charge）
   - ✅ BUFF 区显示充能 BUFF

---

### 5. 测试 onDamaged 触发器（受到伤害时）

**目标**：确认"受到伤害时"触发器正常工作

#### 步骤：
1. 创建一个 passiveDice 物品
2. 添加 Activity：
   ```
   触发时机: 受到伤害时 (onDamaged)
   效果: 为自己添加 1 层守护
   ```
3. 保存并装备此骰子
4. 让角色受到伤害（可以手动扣血或被攻击）
5. **预期结果**：
   - ✅ 聊天窗口显示 Activity 执行消息
   - ✅ 自动获得守护 BUFF

---

### 6. 测试 onFlashStrike 触发器（闪击）

**目标**：确认闪击触发器正常工作

#### 步骤：
1. 创建一个 combatDice 物品，标记为"闪击☪"
2. 添加 Activity：
   ```
   触发时机: 闪击 (onFlashStrike)
   效果: 为自己添加 2 层强壮
   ```
3. 保存并装备，激活此骰子
4. 点击"闪击☪"按钮，选择此骰子
5. **预期结果**：
   - ✅ 聊天窗口显示"闪击☪ 触发"
   - ✅ Activity 效果触发，获得强壮 BUFF
   - ✅ 骰子变为未激活状态

---

### 7. 测试 onDiscard 触发器（丢弃）

**目标**：确认丢弃触发器正常工作

#### 步骤：
1. 创建一个 combatDice 物品，标记为"丢弃✦"
2. 添加 Activity：
   ```
   触发时机: 丢弃 (onDiscard)
   效果: 恢复 1 个 Cost 资源
   ```
3. 保存并装备，激活此骰子
4. 点击"丢弃✦"按钮，选择此骰子
5. **预期结果**：
   - ✅ 聊天窗口显示"丢弃✦ 触发"
   - ✅ Cost 资源恢复 1 个
   - ✅ 骰子变为未激活状态

---

### 8. 测试条件判断

**目标**：确认前置条件正常工作

#### 测试案例 1：自己拥有 BUFF
```
Activity:
  触发: 使用时
  条件: 自己拥有充能 BUFF 且层数 >= 3
  效果: 为自己添加 5 层强壮
  消耗: 消耗 3 层充能
```

**测试步骤**：
1. 不给自己充能 BUFF，使用物品 → 应该无效果（条件不满足）
2. 给自己添加 2 层充能，使用物品 → 应该无效果（层数不够）
3. 给自己添加 5 层充能，使用物品 → 应该成功触发

#### 测试案例 2：对手拥有 BUFF
```
Activity:
  触发: 攻击时
  条件: 对手拥有虚弱 BUFF
  效果: 对目标造成额外 5 点伤害
```

**测试步骤**：
1. 选择没有虚弱 BUFF 的目标攻击 → 无额外伤害
2. 给目标添加虚弱 BUFF，再攻击 → 应该触发额外伤害

---

### 9. 测试消耗模式

**目标**：确认消耗资源正常工作

#### 测试案例：强制消耗
```
Activity:
  触发: 使用时
  消耗模式: 强制消耗
  消耗资源: 3 层充能
  效果: 对目标造成 2d6 点伤害
```

**测试步骤**：
1. 不给充能 BUFF，使用物品 → 应该失败（资源不足）
2. 给 2 层充能，使用物品 → 应该失败（层数不够）
3. 给 5 层充能，使用物品 → 应该成功，充能减少 3 层

---

### 10. 测试表达式解析

**目标**：确认动态表达式正常工作

#### 测试案例：
```
Activity:
  触发: 使用时
  效果: 造成 {charge.layers}*2 点伤害
```

**测试步骤**：
1. 给自己 3 层充能，使用物品 → 应该造成 6 点伤害
2. 给自己 5 层充能，使用物品 → 应该造成 10 点伤害

---

## 已知限制

以下触发器尚未完全实现调用点，需要在战斗逻辑中添加：

- ⏳ **onAttackHit** (攻击命中时) - 需要在伤害结算后调用
- ⏳ **onCounter** (对抗时) - 需要在对抗开始时调用
- ⏳ **onCounterWin** (对抗胜利时) - 需要在对抗结算后调用
- ⏳ **onCounterLose** (对抗失败时) - 需要在对抗结算后调用

这些触发器的 ActivityExecutor 逻辑已经实现，只是还没有在对应的战斗流程中调用 `executeActivities()`。

---

## 报告问题

如果测试中发现问题，请提供以下信息：

1. **测试步骤**：你做了什么操作
2. **预期结果**：应该发生什么
3. **实际结果**：实际发生了什么
4. **错误信息**：F12 控制台中的红色报错（如果有）
5. **Activity 配置**：你创建的 Activity 的完整配置

---

## 版本信息

- **修复日期**: 2025-11-17
- **分支**: `claude/claude-md-mi2vts2mpbrg0sbp-01YJKzhyuQ1prC8EnsFUAvcY`
- **相关 Commits**:
  - `bb30328` - 修复 Handlebars helper 错误
  - `62ec3ce` - 内联 partials 到主模板
  - `e8bf61d` - 修复 Activity 系统集成和编辑器问题
  - `00774a9` - 添加缺失的触发器调用点
